import{r as e}from"./vendor-react-DYPeng9G.js";import{u as i,s}from"./index-0LlzAmpO.js";const t={admin:{dashboard:{visible:!0,actions:{}},tasks:{visible:!0,actions:{create:!0,edit:!0,delete:!0,reassign:!0}},clients:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},cases:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},calendar:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},documents:{visible:!0,actions:{upload:!0,delete:!0}},billing:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},team:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},reports:{visible:!0,actions:{}},settings:{visible:!0,actions:{}}},gerant:{dashboard:{visible:!0,actions:{}},tasks:{visible:!0,actions:{create:!0,edit:!0,delete:!0,reassign:!0}},clients:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},cases:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},calendar:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},documents:{visible:!0,actions:{upload:!0,delete:!0}},billing:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},team:{visible:!0,actions:{create:!0,edit:!0,delete:!0}},reports:{visible:!0,actions:{}},settings:{visible:!0,actions:{}}},avocat:{dashboard:{visible:!0,actions:{}},tasks:{visible:!0,actions:{create:!0,edit:!0,delete:!1,reassign:!1}},clients:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},cases:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},calendar:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},documents:{visible:!0,actions:{upload:!0,delete:!1}},billing:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},team:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},reports:{visible:!0,actions:{}},settings:{visible:!1,actions:{}}},secretaire:{dashboard:{visible:!0,actions:{}},tasks:{visible:!0,actions:{create:!0,edit:!1,delete:!1,reassign:!1}},clients:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},cases:{visible:!0,actions:{create:!1,edit:!0,delete:!1}},calendar:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},documents:{visible:!0,actions:{upload:!0,delete:!1}},billing:{visible:!0,actions:{create:!0,edit:!0,delete:!1}},team:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},reports:{visible:!0,actions:{}},settings:{visible:!1,actions:{}}},user:{dashboard:{visible:!0,actions:{}},tasks:{visible:!0,actions:{create:!1,edit:!1,delete:!1,reassign:!1}},clients:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},cases:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},calendar:{visible:!0,actions:{create:!1,edit:!1,delete:!1}},documents:{visible:!1,actions:{upload:!1,delete:!1}},billing:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},team:{visible:!1,actions:{create:!1,edit:!1,delete:!1}},reports:{visible:!1,actions:{}},settings:{visible:!1,actions:{}}}},r=()=>{const{toast:r}=i(),[a,n]=e.useState([]),[c,l]=e.useState(!1),o=async()=>{l(!0);try{const{data:e,error:i}=await s.from("profiles").select('id, email, name, role, "function", created_at').order("name");if(i)return void r({variant:"destructive",title:"Erreur",description:"Impossible de charger les utilisateurs."});n(e||[])}catch(e){r({variant:"destructive",title:"Erreur",description:"Une erreur inattendue est survenue."})}finally{l(!1)}},d=async(e,i,t=null,a=null)=>{try{const{error:n}=await s.from("user_permissions").upsert({user_id:e,permissions:i},{onConflict:"user_id"});if(n)throw n;if(t||a){const i={};t&&(i.role=t),a&&(i.function=a);const{error:r}=await s.from("profiles").update(i).eq("id",e);if(r)throw r}return r({title:"✅ Permissions sauvegardées",description:"Les permissions ont été mises à jour avec succès."}),await o(),{success:!0}}catch(n){return r({variant:"destructive",title:"Erreur de sauvegarde",description:`Impossible de sauvegarder: ${n.message}`}),{success:!1,error:n}}},u=e=>t[e]||t.user;return{users:a,loading:c,fetchUsers:o,getUserPermissions:async e=>{try{const{data:i,error:t}=await s.from("user_permissions").select("permissions").eq("user_id",e).maybeSingle();return t?null:i?.permissions||null}catch(i){return null}},saveUserPermissions:d,createUser:async e=>{try{const i=crypto.randomUUID(),t=`${e.name.split(" ")[0]}2024!`,{data:r,error:a}=await s.rpc("create_collaborator_with_initial_password",{user_id:i,user_email:e.email,user_name:e.name,user_role:e.role||"user",user_function:e.function||null,initial_password:t});if(a)throw new Error(`Erreur RPC: ${a.message||JSON.stringify(a)}`);if(!r?.success)throw new Error(r?.error||"Échec de la création via RPC");const{data:n,error:c}=await s.from("profiles").select('id, email, name, role, "function", created_at').eq("id",i).single();if(c)throw new Error(`Impossible de récupérer l'utilisateur: ${c.message}`);const l=u(e.role||"user");return(await d(i,l)).success,{success:!0,user:n,initialPassword:t}}catch(i){return r({variant:"destructive",title:"Erreur de création",description:i.message||"Impossible de créer l'utilisateur"}),{success:!1,error:i}}},applyDefaultPermissions:u}},a=(e,i,s=null)=>{if(!e||!e[i])return!1;const t=e[i];return!!t.visible&&(!s||!t.actions||!0===t.actions[s])},n=e=>e&&("Gerant"===e.function||"Associe Emerite"===e.function||"admin"===e.role||"gerant"===e.role);export{t as d,a as h,n as i,r as u};
