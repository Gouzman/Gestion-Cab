import{r as e,j as t}from"./vendor-react-DYPeng9G.js";import{B as s,s as a,t as i,d as r}from"./index-0LlzAmpO.js";import{m as l,X as n,am as c,F as o,an as d,ao as u,a7 as m,_ as x,c as f,M as h,I as p,ap as b,J as g}from"./vendor-ui-DYDeDtSQ.js";import{c as v}from"./filePreviewUtils-Bb8NGExJ.js";import"./vendor-supabase-DEEIiAjM.js";const j=({currentUser:r,onCancel:o,onDocumentUploaded:d})=>{const[u,m]=e.useState({document_reference:"",linked_case_id:"",category:"",description:"",file:null}),[x,f]=e.useState([]),[h,p]=e.useState(!1),b=e.useRef(null);e.useEffect(()=>{(async()=>{const{data:e,error:t}=await a.from("cases").select("id, title").order("created_at",{ascending:!1});t||f(e||[])})()},[]);const g=e=>{const{name:t,value:s}=e.target;m(e=>({...e,[t]:s}))},v=e=>{["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","image/png","image/jpeg"].includes(e.type)?e.size>10485760?i({variant:"destructive",title:"Fichier trop volumineux",description:"La taille maximale autorisÃ©e est de 10 Mo."}):(m(t=>({...t,file:e})),i({title:"ðŸ“Ž Fichier sÃ©lectionnÃ©",description:e.name})):i({variant:"destructive",title:"Format non autorisÃ©",description:"Seuls les formats PDF, DOCX, PNG et JPG sont acceptÃ©s."})};return t.jsx(l.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50",onClick:o,children:t.jsxs(l.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto",onClick:e=>e.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-white",children:"TransfÃ©rer un document"}),t.jsx(s,{variant:"ghost",size:"icon",onClick:o,className:"text-slate-400 hover:text-white",children:t.jsx(n,{className:"w-5 h-5"})})]}),t.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),u.document_reference.trim())if(u.category)if(u.file)try{const e=u.file.name.split(".").pop(),t=`documents/${`${Date.now()}-${Math.random().toString(36).substring(7)}.${e}`}`,s=await u.file.arrayBuffer(),{data:l,error:n}=await a.storage.from("task-files").upload(t,s,{cacheControl:"3600",upsert:!1,contentType:u.file.type});if(n){let e="Impossible de tÃ©lÃ©verser le fichier vers le stockage.";return n.message?.includes("Bucket not found")?e='Le bucket de stockage "task-files" n\'existe pas. Veuillez le crÃ©er dans Supabase Storage.':n.message?.includes("new row violates")&&(e="Erreur de permissions. VÃ©rifiez les politiques RLS du bucket."),void i({variant:"destructive",title:"Erreur d'upload",description:e})}const{data:{publicUrl:c}}=a.storage.from("task-files").getPublicUrl(t),m={task_id:null,case_id:u.linked_case_id||null,file_name:u.file.name,file_url:c,file_type:u.file.type,file_size:u.file.size,document_category:u.category,created_by:r.id},{data:x,error:f}=await a.from("tasks_files").insert([m]).select().single();if(f)return await a.storage.from("task-files").remove([t]),void i({variant:"destructive",title:"Erreur de sauvegarde",description:"Impossible d'enregistrer les mÃ©tadonnÃ©es du document."});i({title:"âœ… Document transfÃ©rÃ©",description:`"${u.file.name}" a Ã©tÃ© ajoutÃ© avec succÃ¨s.`}),d&&d(x),o()}catch(t){i({variant:"destructive",title:"Erreur",description:"Impossible de transfÃ©rer le document."})}else i({variant:"destructive",title:"Fichier manquant",description:"Veuillez sÃ©lectionner un fichier Ã  transfÃ©rer."});else i({variant:"destructive",title:"Champs requis",description:"Veuillez sÃ©lectionner une catÃ©gorie."});else i({variant:"destructive",title:"Champs requis",description:"La rÃ©fÃ©rence du document est obligatoire."})},className:"space-y-6",children:[t.jsxs("div",{onDragOver:e=>{e.preventDefault(),p(!0)},onDragLeave:e=>{e.preventDefault(),p(!1)},onDrop:e=>{e.preventDefault(),p(!1);const t=e.dataTransfer.files;t.length>0&&v(t[0])},className:"border-2 border-dashed rounded-lg p-12 text-center transition-colors "+(h?"border-indigo-500 bg-indigo-500/10":"border-slate-600 bg-slate-700/30"),children:[t.jsx(c,{className:"w-12 h-12 text-slate-400 mx-auto mb-4"}),t.jsxs("p",{className:"text-slate-300 mb-1",children:[t.jsx("button",{type:"button",onClick:()=>b.current?.click(),className:"text-indigo-400 hover:text-indigo-300 hover:underline font-medium",children:"Cliquez pour transfÃ©rer"})," ","ou glissez-dÃ©posez"]}),t.jsx("p",{className:"text-sm text-slate-400",children:"PDF, DOCX, PNG, JPG (MAX. 10MB)"}),u.file&&t.jsxs("p",{className:"mt-3 text-sm text-green-400 font-medium",children:["âœ“ ",u.file.name]})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[t.jsxs("div",{children:[t.jsx("label",{htmlFor:"document-reference",className:"block text-sm font-medium text-slate-300 mb-2",children:"RÃ©f. Document *"}),t.jsx("input",{type:"text",id:"document-reference",name:"document_reference",value:u.document_reference,onChange:g,required:!0,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"RÃ©fÃ©rence interne"})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"linked-case",className:"block text-sm font-medium text-slate-300 mb-2",children:"Dossier associÃ©"}),t.jsxs("select",{id:"linked-case",name:"linked_case_id",value:u.linked_case_id,onChange:g,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500",children:[t.jsx("option",{value:"",children:"Choisir un dossier..."}),x.map(e=>t.jsxs("option",{value:e.id,children:[e.id," - ",e.title]},e.id))]})]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"category",className:"block text-sm font-medium text-slate-300 mb-2",children:"CatÃ©gorie *"}),t.jsxs("select",{id:"category",name:"category",value:u.category,onChange:g,required:!0,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500",children:[t.jsx("option",{value:"",children:"SÃ©lectionner une catÃ©gorie..."}),[{value:"Documents de suivi et facturation",label:"Documents de suivi et facturation"},{value:"PiÃ¨ces",label:"PiÃ¨ces"},{value:"Ã‰critures",label:"Ã‰critures"},{value:"Courriers",label:"Courriers"},{value:"Observations et notes",label:"Observations et notes"},{value:"Autres",label:"Autres"}].map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))]})]}),t.jsxs("div",{children:[t.jsx("label",{htmlFor:"description",className:"block text-sm font-medium text-slate-300 mb-2",children:"Description"}),t.jsx("textarea",{id:"description",name:"description",value:u.description,onChange:g,rows:4,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500",placeholder:"Ajouter une brÃ¨ve description du document..."})]}),t.jsx("input",{ref:b,type:"file",className:"hidden",accept:".pdf,.docx,.png,.jpg,.jpeg",onChange:e=>{const t=e.target.files;t.length>0&&v(t[0])}}),t.jsxs("div",{className:"flex gap-4 pt-4",children:[t.jsx(s,{type:"button",variant:"outline",onClick:o,className:"flex-1 border-slate-600 text-slate-300 hover:bg-slate-700",children:"Annuler"}),t.jsx(s,{type:"submit",className:"flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white",children:"TransfÃ©rer"})]})]})]})})},y=({document:r,onCancel:c,onTransferred:u})=>{const[m,x]=e.useState(""),[f,h]=e.useState(!0),[p,b]=e.useState([]),[g,v]=e.useState(!1);e.useEffect(()=>{(async()=>{if(!r.caseId)return void i({variant:"destructive",title:"Erreur",description:"Ce document n'est pas liÃ© Ã  un dossier."});const{data:e,error:t}=await a.from("tasks").select("id, title, status").eq("case_id",r.caseId).order("created_at",{ascending:!1});t?i({variant:"destructive",title:"Erreur",description:"Impossible de charger les tÃ¢ches du dossier."}):b(e||[])})()},[r.caseId]);return t.jsx(l.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:c,children:t.jsxs(l.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},onClick:e=>e.stopPropagation(),className:"bg-slate-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-slate-700",children:[t.jsxs("div",{className:"sticky top-0 bg-slate-800 border-b border-slate-700 px-6 py-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center",children:t.jsx(o,{className:"w-5 h-5 text-blue-400"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-xl font-bold text-white",children:"TransfÃ©rer vers une tÃ¢che"}),t.jsx("p",{className:"text-sm text-slate-400",children:r.name})]})]}),t.jsx(s,{variant:"ghost",size:"icon",onClick:c,children:t.jsx(n,{className:"w-5 h-5 text-slate-400"})})]}),t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"TÃ¢che de destination *"}),t.jsxs("select",{value:m,onChange:e=>x(e.target.value),className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:g,children:[t.jsx("option",{value:"",children:"SÃ©lectionner une tÃ¢che..."}),p.map(e=>t.jsxs("option",{value:e.id,children:[e.title," (",e.status,")"]},e.id))]}),0===p.length&&t.jsx("p",{className:"text-sm text-slate-500 mt-2",children:"Aucune tÃ¢che disponible dans ce dossier."})]}),t.jsx("div",{className:"bg-slate-700/30 rounded-lg p-4 border border-slate-600/50",children:t.jsxs("label",{className:"flex items-start gap-3 cursor-pointer",children:[t.jsxs("div",{className:"relative flex items-center",children:[t.jsx("input",{type:"checkbox",checked:f,onChange:e=>h(e.target.checked),className:"sr-only peer",disabled:g}),t.jsx("div",{className:"w-5 h-5 border-2 border-slate-500 rounded peer-checked:bg-blue-500 peer-checked:border-blue-500 flex items-center justify-center transition-colors",children:f&&t.jsx(d,{className:"w-3.5 h-3.5 text-white"})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-medium text-white",children:"Visible par l'assignÃ© de la tÃ¢che"}),t.jsx("div",{className:"text-sm text-slate-400 mt-1",children:"Si cochÃ©e, le document apparaÃ®tra dans l'onglet Documents de la tÃ¢che pour l'utilisateur assignÃ©. Sinon, le document reste liÃ© uniquement au dossier."})]})]})}),t.jsxs("div",{className:"bg-slate-700/20 rounded-lg p-4 border border-slate-600/30",children:[t.jsx("h3",{className:"text-sm font-medium text-slate-300 mb-3",children:"Informations du document"}),t.jsxs("div",{className:"space-y-2 text-sm",children:[r.caseTitle&&t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-slate-400",children:"Dossier :"}),t.jsx("span",{className:"text-white font-medium",children:r.caseTitle})]}),r.category&&t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-slate-400",children:"CatÃ©gorie :"}),t.jsx("span",{className:"text-blue-400",children:r.category})]}),r.fileSize&&t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-slate-400",children:"Taille :"}),t.jsxs("span",{className:"text-slate-300",children:[(r.fileSize/1048576).toFixed(2)," Mo"]})]})]})]})]}),t.jsxs("div",{className:"sticky bottom-0 bg-slate-800 border-t border-slate-700 px-6 py-4 flex gap-3 justify-end",children:[t.jsx(s,{variant:"ghost",onClick:c,disabled:g,className:"text-slate-300 hover:text-white",children:"Annuler"}),t.jsx(s,{onClick:async()=>{if(m){v(!0);try{const{data:t,error:s}=await a.from("tasks_files").select("id").eq("file_url",r.url).eq("task_id",m);if(s)throw new Error(`Erreur de vÃ©rification: ${s.message}`);if(t&&t.length>0)return i({title:"DÃ©jÃ  liÃ©",description:"Ce document est dÃ©jÃ  liÃ© Ã  cette tÃ¢che."}),void v(!1);const l={task_id:m,case_id:r.caseId,file_name:r.name,file_url:r.url,file_size:r.fileSize||null,file_type:r.fileType||null,document_category:r.category||null,created_by:r.createdBy||null};try{const{error:e}=await a.from("tasks_files").select("visible_for_assigned").limit(1);e||(l.visible_for_assigned=f)}catch(e){}const{data:n,error:o}=await a.from("tasks_files").insert(l).select("*").single();if(o)throw new Error(`Erreur d'insertion: ${o.message}`);i({title:"âœ… Document transfÃ©rÃ©",description:`Le document a Ã©tÃ© transfÃ©rÃ© vers la tÃ¢che${f?" et est visible pour l'assignÃ©":""}.`}),u(),c()}catch(t){i({variant:"destructive",title:"Erreur de transfert",description:t.message||"Impossible de transfÃ©rer le document."})}finally{v(!1)}}else i({variant:"destructive",title:"TÃ¢che requise",description:"Veuillez sÃ©lectionner une tÃ¢che."})},disabled:g||!m,className:"bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700",children:g?"Transfert...":"TransfÃ©rer le document"})]})]})})},w=({currentUser:n})=>{const[d,w]=e.useState([]),[N,k]=e.useState(""),[_,C]=e.useState(null),[S,D]=e.useState(!1),[T,z]=e.useState(!1),[I,E]=e.useState(null),[L,q]=e.useState("all"),A=n&&("Gerant"===n.function||"Associe Emerite"===n.function||n.role&&"admin"===n.role.toLowerCase()),P=[{id:"all",label:"Tous les documents",icon:o},{id:"Documents de suivi et facturation",label:"Documents de suivi et facturation",icon:u},{id:"PiÃ¨ces",label:"PiÃ¨ces",icon:u},{id:"Ã‰critures",label:"Ã‰critures",icon:u},{id:"Courriers",label:"Courriers",icon:u},{id:"Observations et notes",label:"Observations et notes",icon:u},{id:"Autres",label:"Autres",icon:u}];e.useEffect(()=>{(async()=>{const{data:e}=await a.from("profiles").select("*").eq("id",n.id).single();C(e)})()},[n]),e.useEffect(()=>{_&&(async()=>{try{const{data:e,error:t}=await a.from("tasks_files").select("\n                id,\n                file_name,\n                file_url,\n                file_type,\n                file_size,\n                document_category,\n                created_at,\n                task_id,\n                case_id,\n                created_by\n              ").order("created_at",{ascending:!1});if(t)return"PGRST204"===t.code||t.code,void w([]);const s=[...new Set(e.filter(e=>e.case_id).map(e=>e.case_id))];let i={};if(s.length>0){const{data:e}=await a.from("cases").select("id, title").in("id",s);e&&(i=e.reduce((e,t)=>(e[t.id]=t.title,e),{}))}const r=[...new Set(e.filter(e=>e.task_id).map(e=>e.task_id))];let l={};if(r.length>0){const{data:e}=await a.from("tasks").select("id, title").in("id",r);e&&(l=e.reduce((e,t)=>(e[t.id]=t.title,e),{}))}const n=[...new Set(e.filter(e=>e.created_by).map(e=>e.created_by))];let c={};if(n.length>0){const{data:e}=await a.from("profiles").select("id, name").in("id",n);e&&(c=e.reduce((e,t)=>(e[t.id]=t.name,e),{}))}const o=(e||[]).map(e=>{let t="Documents sans tÃ¢che",s="standalone",a=null;return e.task_id&&e.case_id?(t=l[e.task_id]||"TÃ¢che supprimÃ©e",a=i[e.case_id]||null,s="task-and-case"):e.task_id?(t=l[e.task_id]||"TÃ¢che supprimÃ©e",s="task"):e.case_id&&(t=i[e.case_id]||"Dossier supprimÃ©",a=i[e.case_id]||null,s="case"),{id:e.id,name:e.file_name,path:e.file_url,url:e.file_url,taskTitle:t,taskId:e.task_id,caseId:e.case_id,caseTitle:a,source:s,date:e.created_at,fileType:e.file_type,fileSize:e.file_size,category:e.document_category,createdBy:e.created_by,createdByName:c[e.created_by]||null,timeSpent:0}}),d=Array.from(new Map(o.map(e=>[e.url,e])).values());w(d)}catch(e){w([])}})()},[n,_,A]);const R=e.useMemo(()=>{const e={all:d.length};return P.forEach(t=>{"all"!==t.id&&(e[t.id]=0)}),d.forEach(t=>{t.category?e[t.category]=(e[t.category]||0)+1:e.Autres=(e.Autres||0)+1}),e},[d,P]),U=d.filter(e=>{const t=e.name&&e.name.toLowerCase().includes(N.toLowerCase())||e.taskTitle&&e.taskTitle.toLowerCase().includes(N.toLowerCase());return"all"===L?t:"Autres"===L?t&&(!e.category||"Autres"===e.category):t&&e.category===L}),$=U.reduce((e,t)=>{const s=t.taskId||"no-task";return e[s]||(e[s]={taskTitle:t.taskTitle||`TÃ¢che #${t.taskId}`,taskId:t.taskId,files:[]}),e[s].files.push(t),e},{});return Object.values($),t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Gestion des Documents"}),t.jsx("p",{className:"text-slate-400",children:"Retrouvez tous les fichiers liÃ©s Ã  vos tÃ¢ches"})]}),t.jsxs(s,{onClick:()=>D(!0),className:"bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700",children:[t.jsx(c,{className:"w-4 h-4 mr-2"}),"TransfÃ©rer Document"]})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[t.jsx("div",{className:"lg:col-span-1",children:t.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[t.jsx(m,{className:"w-5 h-5"}),"CatÃ©gories"]}),t.jsx("div",{className:"space-y-2",children:P.map(e=>{const s=R[e.id]||0,a=L===e.id;return t.jsxs("button",{onClick:()=>q(e.id),className:"w-full text-left px-4 py-3 rounded-lg transition-all duration-200 flex items-center justify-between gap-3 "+(a?"bg-blue-600 text-white shadow-lg shadow-blue-500/20 font-semibold":"text-slate-300 hover:bg-slate-700/50 hover:text-white"),children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(e.icon,{className:"w-4 h-4 "+(a?"text-white":"text-slate-400")}),t.jsx("span",{className:"text-sm",children:e.label})]}),t.jsx("span",{className:"text-xs px-2 py-1 rounded-full "+(a?"bg-white/20 text-white font-semibold":"bg-slate-700/50 text-slate-400"),children:s})]},e.id)})})]})}),t.jsxs("div",{className:"lg:col-span-3 space-y-4",children:[t.jsx("div",{className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-6",children:t.jsxs("div",{className:"relative",children:[t.jsx(x,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-5 h-5"}),t.jsx("input",{type:"text",placeholder:"Rechercher un document par nom ou par tÃ¢che...",value:N,onChange:e=>k(e.target.value),className:"w-full pl-12 pr-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),0===U.length?t.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-12 text-center",children:[t.jsx(f,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),t.jsx("h3",{className:"text-xl font-semibold text-slate-400 mb-2",children:"Aucun document trouvÃ©"}),t.jsx("p",{className:"text-slate-500",children:"Les fichiers que vous joignez aux tÃ¢ches apparaÃ®tront ici."})]}):t.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:U.map((e,n)=>t.jsxs(l.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.05*n},className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl overflow-hidden hover:border-slate-600/50 transition-all",children:[t.jsx("div",{className:"p-6 pb-4",children:t.jsxs("div",{className:"flex items-start gap-4",children:[t.jsx("div",{className:"flex-shrink-0",children:t.jsx("div",{className:"w-14 h-14 bg-blue-500/10 rounded-lg flex items-center justify-center",children:t.jsx(o,{className:"w-7 h-7 text-blue-400"})})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("h3",{className:"text-base font-bold text-white mb-2 break-words",title:e.name,children:(e=>{if(!e)return"Document";if(e.length<=40)return e;const t=e.lastIndexOf(".");if(-1===t)return e.substring(0,37)+"...";const s=e.substring(t);return e.substring(0,t).substring(0,37-s.length)+"..."+s})(e.name)}),t.jsx("div",{className:"text-sm text-slate-400 mb-1 font-medium",children:e.caseTitle?e.caseTitle:e.taskId?e.taskTitle:"Sans dossier"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-slate-500 mb-2",children:[e.fileSize&&t.jsx("span",{children:(e=>{if(!e)return"";const t=e/1048576,s=e/1024;return t>=1?`${t.toFixed(1)} Mo`:`${Math.round(s)} Ko`})(e.fileSize)}),t.jsx("span",{children:"â€¢"}),t.jsx("span",{children:new Date(e.date).toLocaleDateString("fr-FR")})]}),e.createdByName&&t.jsxs("div",{className:"text-xs text-slate-500 mb-2",children:["Par ",e.createdByName]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-2",children:[e.category&&t.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-500/10 text-blue-400 text-xs rounded-full",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-blue-400"}),e.category]}),e.taskId&&t.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-green-500/10 text-green-400 text-xs rounded-full",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-green-400"}),"LiÃ© Ã  une tÃ¢che"]}),e.caseId&&!e.taskId&&t.jsxs("span",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-slate-600/30 text-slate-400 text-xs rounded-full",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-slate-400"}),"Document de dossier"]})]})]})]})}),t.jsxs("div",{className:"px-6 py-4 bg-slate-700/30 border-t border-slate-700/50 flex items-center justify-center gap-2 flex-wrap",children:[t.jsxs(s,{variant:"ghost",size:"sm",onClick:()=>(e=>{if(e&&e.startsWith("http")){const t=e.includes("?")?`${e}&download=`:`${e}?download=`;window.open(t,"_blank","noopener,noreferrer")}else i({variant:"destructive",title:"Erreur",description:"URL du fichier invalide."})})(e.url),className:"text-slate-300 hover:text-white hover:bg-slate-600/50",children:[t.jsx(h,{className:"w-4 h-4 mr-2"}),"Voir"]}),t.jsxs(s,{variant:"ghost",size:"sm",onClick:()=>(async(e,t)=>{if(e&&e.startsWith("http"))try{new URL(e);const s=await r(e);if(!s||0===s.size)return void i({variant:"destructive",title:"Erreur",description:"Le fichier tÃ©lÃ©chargÃ© est vide ou corrompu."});const a=window.URL.createObjectURL(s),l=document.createElement("a");l.href=a;const n=v(t);l.download=n,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(a),document.body.removeChild(l)}catch(s){i({variant:"destructive",title:"Erreur",description:"Impossible de tÃ©lÃ©charger le fichier."})}else i({variant:"destructive",title:"Erreur",description:"URL du fichier invalide."})})(e.url,e.name),className:"text-slate-300 hover:text-white hover:bg-slate-600/50",children:[t.jsx(p,{className:"w-4 h-4 mr-2"}),"TÃ©lÃ©charger"]}),e.caseId&&t.jsxs(s,{variant:"ghost",size:"sm",onClick:()=>{E(e),z(!0)},className:"text-blue-400 hover:text-blue-300 hover:bg-blue-500/10",children:[t.jsx(b,{className:"w-4 h-4 mr-2"}),"TransfÃ©rer vers tÃ¢che"]}),t.jsxs(s,{variant:"ghost",size:"sm",onClick:()=>{window.confirm(`Voulez-vous vraiment supprimer le document "${e.name}" ?\n\nCette action est irrÃ©versible.`)&&(async e=>{try{const{error:t}=await a.from("tasks_files").delete().eq("id",e.id);if(t)return void i({variant:"destructive",title:"Erreur",description:"Impossible de supprimer le fichier."});w(d.filter(t=>t.id!==e.id)),i({title:"ðŸ—‘ï¸ Document supprimÃ©",description:`${e.name} a Ã©tÃ© supprimÃ©.`})}catch(t){i({variant:"destructive",title:"Erreur",description:"Impossible de supprimer le fichier."})}})(e)},className:"text-red-400 hover:text-red-300 hover:bg-red-500/10",children:[t.jsx(g,{className:"w-4 h-4 mr-2"}),"Supprimer"]})]})]},e.id))})]})]}),S&&t.jsx(j,{currentUser:n,onCancel:()=>D(!1),onDocumentUploaded:async e=>{let t="Document indÃ©pendant";if(e.task_id){const{data:s}=await a.from("cases").select("title").eq("id",e.task_id).single();s&&(t=s.title)}const s={id:e.id,name:e.file_name,path:e.file_url,url:e.file_url,taskTitle:t,taskId:e.task_id,date:e.created_at,fileType:e.file_type,fileSize:e.file_size,category:e.document_category,timeSpent:0};w(e=>[s,...e])}}),T&&I&&t.jsx(y,{document:I,onCancel:()=>{z(!1),E(null)},onTransferred:()=>{window.location.reload()}})]})};export{w as default};
