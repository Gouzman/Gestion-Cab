const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-0LlzAmpO.js","assets/vendor-react-DYPeng9G.js","assets/vendor-ui-DYDeDtSQ.js","assets/vendor-supabase-DEEIiAjM.js","assets/index--n1wdZXJ.css"])))=>i.map(i=>d[i]);
import{B as e,t as s,_ as t,s as i,g as a}from"./index-0LlzAmpO.js";import{r as n,j as l,P as r}from"./vendor-react-DYPeng9G.js";import{C as o,L as c}from"./label-BZj4Sq3D.js";import{m as d,X as u,b as m,F as p,u as h,y as x,z as g,G as f,I as b,J as v,M as j,N as _,O as y,Z as w,Q as N,W as k,Y as C,_ as E,$ as T,l as S,n as F,q as A}from"./vendor-ui-DYDeDtSQ.js";import{h as D,d as $}from"./filePreviewUtils-Bb8NGExJ.js";import{A as L,a as M,b as I,c as z,d as P,e as R,f as U,g as O,C as q}from"./ConfirmationModal-CduQsMHX.js";import"./vendor-supabase-DEEIiAjM.js";const V=[{name:"Mise en Ã©tat et suivi de dossiers",tasks:["Ouverture de dossier","Constitution et demande de piÃ¨ces","Recherches juridiques","Analyse de dossier","Collecte et gestion des preuves","Transfert ou cession de dossiers","DÃ©pÃ´t et enrÃ´lement d'acte de procÃ©dure","DÃ©pÃ´t et suivi de correspondance","Suivi des dÃ©lais judiciaires","(Re)programmation de dossier","Voies de recours (appel, pourvoi)","ClÃ´ture et archivage de dossier","Archivage de dossier"]},{name:"Conseil et assistance juridiques",tasks:["Consultation et rÃ©daction d'avis juridiques","RÃ©daction d'actes juridiques","RÃ©daction de note de synthÃ¨se","Revue documentaire","Analyse de conformitÃ© lÃ©gislative et rÃ©glementaire","Veille lÃ©gislative et rÃ©glementaire"]},{name:"Conseil et assistance judiciaires",tasks:["Avis juridique ou note de synthÃ¨se","RÃ©daction d'acte introductif d'instance","RÃ©daction d'actes de procÃ©dure","DÃ©pÃ´t et enrÃ´lement d'actes de procÃ©dure","Assistance Ã  la Police judiciaire","Assistance Ã  parquet","Assistance devant le Juge d'instruction ou la Chambre d'instruction","Assistance devant autre organisme ou administration","Audience de plaidoirie","Compte rendu d'audience","Compte rendu de suivi et de gestion de dossier","Suivi des dÃ©lais de procÃ©dure","Collecte et gestion des preuves","Voies de recours","MÃ©diation, arbitrage et rÃ¨glement amiable","PrÃ©paration d'audience ou de plaidoirie","Assistance et reprÃ©sentation en justice","Veille jurisprudentielle et lÃ©gislative"]},{name:"Conseil et assistance fiscale",tasks:["Conseil en fiscalitÃ©","Contentieux fiscal et reprÃ©sentation devant les autoritÃ©s fiscales","DÃ©clarations fiscales","Assistance lors des contrÃ´les fiscaux","Audit de conformitÃ© fiscale"]},{name:"Missions d'audit",tasks:["Audit juridique de l'entreprise","Audit de conformitÃ©","Audit de sociÃ©tÃ©s (due diligence prÃ©-acquisition)","Audit fiscal","Audit social"]},{name:"Corporate (Droit des sociÃ©tÃ©s)",tasks:["CrÃ©ation et dissolution de sociÃ©tÃ©s","RÃ©daction et mise Ã  jour des statuts et pactes d'actionnaires","Tenue des registres lÃ©gaux","RÃ©daction et suivi des procÃ¨s-verbaux d'assemblÃ©e gÃ©nÃ©rale","OpÃ©rations sur capital","FormalitÃ©s auprÃ¨s du RCCM et annonces lÃ©gales"]},{name:"Gestion des ressources humaines",tasks:["Recrutement et intÃ©gration des collaborateurs","Gestion de la paie, des congÃ©s et des absences","Ã‰valuations annuelles et gestion de carriÃ¨re","Plan de formation interne et continue","RÃ©daction et gestion des contrats de travail","Gestion des procÃ©dures de licenciement"]},{name:"SecrÃ©tariat & Administration",tasks:["Gestion de l'agenda et des plannings","Gestion du courrier et des envois","Gestion des fournitures et des achats","Maintenance des locaux et logistique interne","Gestion des contrats avec les fournisseurs et prestataires","Traduction certifiÃ©e","FormalitÃ©s notariales et lÃ©galisations"]},{name:"ComptabilitÃ© & Finance",tasks:["Ã‰mission et suivi des factures d'honoraires","Suivi des encaissements et des relances","Gestion des avances et des dÃ©pÃ´ts","Rapprochement comptable","PrÃ©visions budgÃ©taires","DÃ©claration et paiement des charges","Gestion du parc automobile du cabinet"]},{name:"Communication & DÃ©veloppement",tasks:["Veille et dÃ©veloppement commercial","RÃ©daction de propositions commerciales","Suivi des appels d'offres","Organisation d'Ã©vÃ©nements et de confÃ©rences","RÃ©daction de contenu pour le site web et les rÃ©seaux sociaux"]},{name:"Community management",tasks:["Gestion des rÃ©seaux sociaux","Diffusion de veille juridique externe","Valorisation de l'image du cabinet","Suivi e-rÃ©putation et rÃ©ponses digitales"]},{name:"Relations avec experts et tiers",tasks:["Coordination avec huissiers, notaires, experts judiciaires","Transmission d'acte pour signification","Demande de constat","Transmission d'acte pour authentification","Suivi des rapports d'expertise","Gestion des consultants et experts externes"]},{name:"ConformitÃ© & Risques",tasks:["Mise en place des procÃ©dures KYC (Know Your Customer) et LCB-FT (Lutte Contre le Blanchiment de capitaux et le Financement du Terrorisme)","ConformitÃ© lÃ©gislative et rÃ©glementaire, et protection des donnÃ©es","Audit de conformitÃ© interne","Gestion des incidents de sÃ©curitÃ© et des fuites de donnÃ©es","Gestion des risques opÃ©rationnels"]},{name:"Gestion Documentaire",tasks:["NumÃ©risation, classement et indexation des documents","Mise Ã  jour des modÃ¨les et templates de documents","Archivage et destruction programmÃ©e des dossiers","Sauvegarde et sÃ©curisation des donnÃ©es"]},{name:"IT & SystÃ¨mes d'Information",tasks:["Support informatique interne","Sauvegarde des donnÃ©es et systÃ¨mes","Gestion des accÃ¨s et des droits utilisateurs","SÃ©curitÃ© informatique et gestion des incidents"]}],W=({task:i,onSubmit:a,onCancel:r,teamMembers:_,cases:y,currentUser:w})=>{const[N,k]=n.useState({title:"",description:"",priority:"medium",status:"pending",deadline:"",assigned_to_id:"",assigned_to_ids:[],visible_by_ids:[],case_id:"",main_category:"",associated_tasks:[],attachments:[],filesToUpload:[],scannedFiles:[]}),[C,E]=n.useState(""),[T,S]=n.useState(!1),[F,A]=n.useState([]),[D,$]=n.useState(!1);n.useEffect(()=>{(async()=>{try{if("ImageCapture"in globalThis&&navigator.mediaDevices){const e=(await navigator.mediaDevices.enumerateDevices()).some(e=>"videoinput"===e.kind&&(e.label.toLowerCase().includes("scanner")||e.label.toLowerCase().includes("document")||e.label.toLowerCase().includes("scan")));$(e)}}catch(e){}})()},[]),n.useEffect(()=>{if(i&&(k({title:i.title||"",description:i.description||"",priority:i.priority||"medium",status:i.status||"pending",deadline:i.deadline?new Date(i.deadline).toISOString().substring(0,16):"",assigned_to_id:i.assigned_to_id||"",assigned_to_ids:i.assigned_to_ids||(i.assigned_to_id?[i.assigned_to_id]:[]),visible_by_ids:i.visible_by_ids||[],case_id:i.case_id||"",main_category:i.main_category||"",associated_tasks:i.associated_tasks||[],attachments:i.attachments||[],filesToUpload:[],scannedFiles:[]}),i.main_category)){const e=V.find(e=>e.name===i.main_category);A(e?e.tasks:[])}},[i]);const L=e=>{const{name:s,value:t}=e.target;if(k(e=>({...e,[s]:t})),"main_category"===s){const e=V.find(e=>e.name===t);A(e?e.tasks:[]),k(e=>({...e,associated_tasks:[]}))}},M=async(e,a)=>{if(i?.id)try{const{uploadMultipleTaskFilesWithCategory:n}=await t(async()=>{const{uploadMultipleTaskFilesWithCategory:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFilesWithCategory:e}},__vite__mapDeps([0,1,2,3,4]));s({title:"ðŸ“¤ Upload en cours...",description:`TÃ©lÃ©versement de ${e.length} fichier(s) avec catÃ©gorie "${a}"...`});const l=await n(e,i.id,w?.id,a);if(l.success)s({title:"âœ… Fichiers uploadÃ©s",description:`${l.data.length} fichier(s) tÃ©lÃ©versÃ©(s) avec catÃ©gorie "${a}".`}),window.refreshTaskFiles&&window.refreshTaskFiles(i.id);else if(l.errors.length>0){const e=l.errors.some(e=>e.error?.includes("bucket 'attachments'")||e.error?.includes("n'est pas encore configurÃ©"));s(e?{title:"âš ï¸ Stockage non configurÃ©",description:"Le bucket 'attachments' doit Ãªtre crÃ©Ã© dans Supabase Dashboard > Storage",variant:"destructive"}:{title:"âš ï¸ Erreur d'upload",description:l.summary,variant:"destructive"})}}catch(n){s({variant:"destructive",title:"âŒ Erreur",description:"Impossible d'uploader les fichiers."})}else s({variant:"destructive",title:"âš ï¸ TÃ¢che non enregistrÃ©e",description:"Veuillez d'abord enregistrer la tÃ¢che avant d'ajouter des fichiers."})},I=w&&("Gerant"===w.function||"Associe Emerite"===w.function)||w.role&&"admin"===w.role.toLowerCase(),z=i&&(i.assigned_to_id===w.id||I);return l.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50",children:l.jsxs(d.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto",children:[l.jsxs("div",{className:"flex items-center justify-between mb-6",children:[l.jsx("h2",{className:"text-2xl font-bold text-white",children:i?"Modifier la TÃ¢che":"Nouvelle TÃ¢che"}),l.jsx(e,{variant:"ghost",size:"icon",onClick:r,className:"text-slate-400 hover:text-white",children:l.jsx(u,{className:"w-5 h-5"})})]}),l.jsxs("form",{onSubmit:e=>{e.preventDefault(),a(N)},className:"space-y-6",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Titre de la tÃ¢che *"}),l.jsx("input",{type:"text",name:"title",value:N.title,onChange:L,required:!0,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Ex: PrÃ©parer les conclusions pour l'affaire Martin"})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Description"}),l.jsx("textarea",{name:"description",value:N.description,onChange:L,rows:3,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"DÃ©tails de la tÃ¢che..."})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"CatÃ©gorie tÃ¢che"}),l.jsxs("select",{name:"main_category",value:N.main_category,onChange:L,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"",children:"-- SÃ©lectionner une catÃ©gorie --"}),V.map(e=>l.jsx("option",{value:e.name,children:e.name},e.name))]})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"TÃ¢ches AssociÃ©es"}),l.jsx("div",{className:"p-3 bg-slate-700/50 border border-slate-600 rounded-lg max-h-40 overflow-y-auto",children:F.length>0?F.map(e=>l.jsxs("div",{className:"flex items-center space-x-2 py-1",children:[l.jsx(o,{id:e,checked:N.associated_tasks.includes(e),onCheckedChange:()=>(e=>{k(s=>{const t=s.associated_tasks.includes(e)?s.associated_tasks.filter(s=>s!==e):[...s.associated_tasks,e];return{...s,associated_tasks:t}})})(e)}),l.jsx(c,{htmlFor:e,className:"text-slate-300 font-normal",children:e})]},e)):l.jsx("p",{className:"text-slate-400 text-sm",children:"SÃ©lectionnez d'abord une catÃ©gorie principale."})})]})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"PrioritÃ©"}),l.jsxs("select",{name:"priority",value:N.priority,onChange:L,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"low",children:"ðŸŸ¢ Faible"}),l.jsx("option",{value:"medium",children:"ðŸŸ¡ Moyenne"}),l.jsx("option",{value:"high",children:"ðŸŸ  Ã‰levÃ©e"}),l.jsx("option",{value:"urgent",children:"ðŸ”´ Urgente"})]})]}),l.jsxs("div",{children:[l.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Statut tÃ¢che"}),l.jsxs("select",{name:"status",value:N.status,onChange:L,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"pending",children:"En attente"}),l.jsx("option",{value:"seen",children:"Vue"}),l.jsx("option",{value:"in-progress",children:"En cours"}),l.jsx("option",{value:"completed",children:"TerminÃ©e"})]})]})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:[l.jsx(m,{className:"w-4 h-4 inline mr-2"}),"Ã‰chÃ©ance"]}),l.jsx("input",{type:"datetime-local",name:"deadline",value:N.deadline,onChange:L,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:[l.jsx(p,{className:"w-4 h-4 inline mr-2"}),"Dossier"]}),l.jsxs("select",{name:"case_id",value:N.case_id,onChange:L,className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"",children:"Aucun dossier"}),y&&y.map(e=>l.jsx("option",{value:e.id,children:e.title},e.id))]})]})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:[l.jsx(h,{className:"w-4 h-4 inline mr-2"}),"AssignÃ© Ã  (multi-sÃ©lection)"]}),l.jsx("div",{className:"p-4 bg-slate-700/50 border border-slate-600 rounded-lg max-h-48 overflow-y-auto space-y-2",children:_&&_.length>0?_.map(e=>l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx(o,{id:`assign-${e.id}`,checked:N.assigned_to_ids.includes(e.id),onCheckedChange:s=>{k(t=>({...t,assigned_to_ids:s?[...t.assigned_to_ids,e.id]:t.assigned_to_ids.filter(s=>s!==e.id),assigned_to_id:s&&0===t.assigned_to_ids.length?e.id:t.assigned_to_ids.filter(s=>s!==e.id)[0]||""}))},disabled:!I&&!T&&i&&i.assigned_to_id!==w.id}),l.jsxs(c,{htmlFor:`assign-${e.id}`,className:"text-slate-300 font-normal cursor-pointer flex-1",children:[e.name,e.role&&l.jsxs("span",{className:"ml-2 text-xs text-slate-500",children:["(",e.role,")"]})]})]},e.id)):l.jsx("p",{className:"text-slate-400 text-sm",children:"Aucun membre d'Ã©quipe disponible"})}),N.assigned_to_ids.length>0&&l.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:N.assigned_to_ids.map(e=>{const s=_.find(s=>s.id===e);return s?l.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs bg-blue-500/20 text-blue-300 border border-blue-500/30",children:[s.name,l.jsx("button",{type:"button",onClick:()=>{k(s=>({...s,assigned_to_ids:s.assigned_to_ids.filter(s=>s!==e),assigned_to_id:s.assigned_to_ids.filter(s=>s!==e)[0]||""}))},className:"ml-2 text-blue-300 hover:text-blue-100",children:"Ã—"})]},e):null})})]}),z&&!I&&!T&&l.jsxs(e,{type:"button",variant:"outline",onClick:()=>S(!0),children:[l.jsx(x,{className:"w-4 h-4 mr-2"})," RÃ©assigner la tÃ¢che"]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:[l.jsx(g,{className:"w-4 h-4 inline mr-2"}),"PiÃ¨ces jointes"]}),l.jsxs("div",{className:"mb-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg",children:[l.jsx("label",{className:"block text-sm font-medium text-blue-300 mb-2",children:"ðŸ“ CatÃ©gorie du document *"}),l.jsxs("select",{value:C,onChange:e=>E(e.target.value),className:"w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"",children:"-- SÃ©lectionner une catÃ©gorie --"}),[{value:"Documents de suivi et facturation",label:"Documents de suivi et facturation"},{value:"PiÃ¨ces",label:"PiÃ¨ces"},{value:"Ã‰critures",label:"Ã‰critures"},{value:"Courriers",label:"Courriers"},{value:"Observations et notes",label:"Observations et notes"},{value:"Autres",label:"Autres"}].map(e=>l.jsx("option",{value:e.value,children:e.label},e.value))]}),l.jsx("p",{className:"mt-2 text-xs text-slate-400",children:"âš ï¸ La catÃ©gorie est obligatoire pour tous les documents ajoutÃ©s Ã  cette tÃ¢che."})]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[l.jsxs("label",{htmlFor:"file-internal",className:"cursor-pointer bg-blue-600 hover:bg-blue-700 border border-blue-500 rounded-lg px-4 py-3 text-white font-medium flex items-center justify-center gap-2 transition-colors",children:[l.jsx(p,{className:"w-4 h-4"}),"Choisir des fichiers"]}),l.jsx("input",{id:"file-internal",type:"file",className:"sr-only",onChange:async e=>{if(e.target.files){const t=Array.from(e.target.files);if(!C)return s({variant:"destructive",title:"âš ï¸ CatÃ©gorie requise",description:"Veuillez sÃ©lectionner une catÃ©gorie de document avant d'ajouter des fichiers."}),void(e.target.value="");if(i?.id)await M(t,C);else{const e=t.map(e=>({file:e,category:C}));k(s=>({...s,filesToUpload:[...s.filesToUpload,...e]})),s({title:`ðŸ“Ž ${t.length} fichier(s) ajoutÃ©(s)`,description:`CatÃ©gorie: ${C} - PrÃªt(s) Ã  Ãªtre tÃ©lÃ©versÃ©(s) lors de la sauvegarde.`})}e.target.value=""}},multiple:!0}),l.jsxs(e,{type:"button",variant:"outline",onClick:async()=>{try{if("ImageCapture"in globalThis&&navigator.mediaDevices)try{const e=await navigator.mediaDevices.enumerateDevices(),t=e.filter(e=>"videoinput"===e.kind).find(e=>e.label.toLowerCase().includes("scanner")||e.label.toLowerCase().includes("document")||e.label.toLowerCase().includes("scan"));if(t){s({title:"âœ… Scanner dÃ©tectÃ©",description:`Connexion Ã  ${t.label}...`});const e=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t.deviceId},width:{ideal:1920},height:{ideal:1080}}}),a=document.createElement("video");a.srcObject=e,a.autoplay=!0,a.playsInline=!0;const n=document.createElement("div");n.style.cssText="\n              position: fixed; top: 0; left: 0; width: 100%; height: 100%;\n              background: rgba(0,0,0,0.95); display: flex; flex-direction: column;\n              align-items: center; justify-content: center; z-index: 9999;\n            ";const l=document.createElement("div");l.style.cssText="\n              color: white; font-size: 24px; font-weight: bold; margin-bottom: 20px;\n            ",l.textContent=`ðŸ–¨ï¸ ${t.label}`,a.style.cssText="\n              max-width: 85%; max-height: 60vh; border: 3px solid #3b82f6;\n              border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n            ";const r=document.createElement("p");r.style.cssText="\n              color: #94a3b8; font-size: 14px; margin: 15px 0; max-width: 600px; text-align: center;\n            ",r.textContent='Placez votre document dans le scanner, puis cliquez sur "Capturer" pour numÃ©riser';const o=document.createElement("div");o.style.cssText="display: flex; gap: 15px; margin-top: 20px;";const c=document.createElement("button");c.innerHTML="ðŸ“¸ Capturer le document",c.style.cssText="\n              padding: 15px 40px; font-size: 16px; font-weight: 600;\n              background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);\n              color: white; border: none; border-radius: 8px;\n              cursor: pointer; transition: all 0.3s ease;\n              box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);\n            ",c.onmouseover=()=>{c.style.transform="scale(1.05)",c.style.boxShadow="0 6px 20px rgba(59, 130, 246, 0.6)"},c.onmouseout=()=>{c.style.transform="scale(1)",c.style.boxShadow="0 4px 12px rgba(59, 130, 246, 0.4)"};const d=document.createElement("button");return d.innerHTML="âŒ Annuler",d.style.cssText="\n              padding: 15px 30px; font-size: 16px; font-weight: 600;\n              background: #475569; color: white; border: none; border-radius: 8px;\n              cursor: pointer; transition: all 0.3s ease;\n            ",d.onmouseover=()=>{d.style.background="#64748b"},d.onmouseout=()=>{d.style.background="#475569"},o.appendChild(c),o.appendChild(d),n.appendChild(l),n.appendChild(r),n.appendChild(a),n.appendChild(o),document.body.appendChild(n),await a.play(),c.onclick=async()=>{try{c.disabled=!0,c.innerHTML="â³ NumÃ©risation en cours...";const t=document.createElement("canvas");t.width=a.videoWidth,t.height=a.videoHeight;t.getContext("2d").drawImage(a,0,0,t.width,t.height),t.toBlob(async t=>{if(!t)return s({variant:"destructive",title:"âŒ Erreur de capture",description:"Impossible de capturer l'image. RÃ©essayez."}),c.disabled=!1,void(c.innerHTML="ðŸ“¸ Capturer le document");const a=Date.now(),l=new File([t],`scan_${a}.png`,{type:"image/png"});for(const s of e.getTracks())s.stop();n.remove(),C?i?.id?await M([l],C):(k(e=>({...e,scannedFiles:[...e.scannedFiles,{file:l,category:C}]})),s({title:"âœ… Document numÃ©risÃ©",description:`${l.name} capturÃ© avec succÃ¨s (${(t.size/1024).toFixed(0)} Ko) - CatÃ©gorie: ${C}`})):s({variant:"destructive",title:"âš ï¸ CatÃ©gorie requise",description:"Veuillez sÃ©lectionner une catÃ©gorie de document avant de numÃ©riser."})},"image/png",.95)}catch(t){s({variant:"destructive",title:"âŒ Erreur",description:"Ã‰chec de la numÃ©risation. VÃ©rifiez le scanner."}),c.disabled=!1,c.innerHTML="ðŸ“¸ Capturer le document"}},void(d.onclick=()=>{for(const s of e.getTracks())s.stop();n.remove(),s({title:"NumÃ©risation annulÃ©e",description:"OpÃ©ration interrompue par l'utilisateur"})})}}catch(e){}const t=document.createElement("input");t.type="file",t.accept="image/*,application/pdf",t.multiple=!1,t.setAttribute("webkitdirectory",!1),t.onchange=e=>{const t=e.target.files[0];if(t){if(!t.type.startsWith("image/")&&"application/pdf"!==t.type)return void s({variant:"destructive",title:"âŒ Format non supportÃ©",description:"Veuillez sÃ©lectionner une image ou un PDF."});i?.id?M([t]):(k(e=>({...e,scannedFiles:[...e.scannedFiles,t]})),s({title:"ï¿½ï¸ Document scannÃ©",description:`${t.name} ajoutÃ© depuis le scanner. Il sera uploadÃ© lors de la sauvegarde.`}))}},s({title:"ðŸ–¨ï¸ Scanner",description:"SÃ©lectionnez un document depuis votre scanner ou un fichier dÃ©jÃ  scannÃ©."}),t.click()}catch(t){s({variant:"destructive",title:"âŒ Erreur Scanner",description:"Impossible d'accÃ©der au scanner. VÃ©rifiez les permissions du navigateur."})}},className:"flex items-center justify-center gap-2 border-slate-600 text-slate-300 hover:bg-slate-700 "+(D?"border-green-500 text-green-300 bg-green-500/10":""),title:D?"Scanner dÃ©tectÃ© - Cliquez pour numÃ©riser":"NumÃ©riser un document",children:[l.jsx(f,{className:"w-4 h-4"}),D?"ðŸ–¨ï¸ NumÃ©riser (Scanner actif)":"ðŸ–¨ï¸ NumÃ©riser"]})]}),l.jsxs("div",{className:"mt-2 space-y-2",children:[N.attachments.map((t,i)=>l.jsxs("div",{className:"flex items-center justify-between text-sm text-slate-400 bg-slate-700/30 p-2 rounded-md",children:[l.jsx("span",{children:t.split("/").pop()}),l.jsx(e,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>(async()=>{s({variant:"destructive",title:"Bucket non configurÃ©",description:"Le bucket Storage 'attachments' doit Ãªtre crÃ©Ã© dans Supabase Dashboard"})})(),children:l.jsx(b,{className:"h-4 w-4"})})]},i)),N.filesToUpload.map((s,t)=>l.jsxs("div",{className:"flex items-center justify-between text-sm text-green-400 bg-green-900/30 p-2 rounded-md",children:[l.jsxs("div",{className:"flex-1",children:[l.jsxs("div",{children:["ðŸ“Ž ",s.file.name]}),l.jsxs("div",{className:"text-xs text-blue-300 mt-1",children:["ðŸ·ï¸ ",s.category]})]}),l.jsx(e,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-400 hover:text-red-300",onClick:()=>{k(e=>({...e,filesToUpload:e.filesToUpload.filter((e,s)=>s!==t)}))},children:l.jsx(v,{className:"h-4 w-4"})})]},t)),N.scannedFiles.map((s,t)=>l.jsxs("div",{className:"flex items-center justify-between text-sm text-blue-400 bg-blue-900/30 p-2 rounded-md",children:[l.jsxs("div",{className:"flex-1",children:[l.jsxs("div",{children:["ðŸ“· ",s.file.name]}),l.jsxs("div",{className:"text-xs text-blue-300 mt-1",children:["ðŸ·ï¸ ",s.category]})]}),l.jsx(e,{variant:"ghost",size:"icon",className:"h-6 w-6 text-red-400 hover:text-red-300",onClick:()=>{k(e=>({...e,scannedFiles:e.scannedFiles.filter((e,s)=>s!==t)}))},children:l.jsx(v,{className:"h-4 w-4"})})]},t))]})]}),l.jsxs("div",{children:[l.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:[l.jsx(j,{className:"w-4 h-4 inline mr-2"}),"Visible par (permissions de consultation)"]}),l.jsx("div",{className:"p-4 bg-slate-700/50 border border-slate-600 rounded-lg max-h-48 overflow-y-auto space-y-2",children:_&&_.length>0?l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"flex items-center space-x-2 pb-2 border-b border-slate-600",children:[l.jsx(o,{id:"visible-all",checked:N.visible_by_ids.length===_.length,onCheckedChange:e=>{k(s=>({...s,visible_by_ids:e?_.map(e=>e.id):[]}))}}),l.jsx(c,{htmlFor:"visible-all",className:"text-slate-300 font-semibold cursor-pointer flex-1",children:"Tous les membres"})]}),_.map(e=>l.jsxs("div",{className:"flex items-center space-x-2",children:[l.jsx(o,{id:`visible-${e.id}`,checked:N.visible_by_ids.includes(e.id),onCheckedChange:s=>{k(t=>({...t,visible_by_ids:s?[...t.visible_by_ids,e.id]:t.visible_by_ids.filter(s=>s!==e.id)}))}}),l.jsxs(c,{htmlFor:`visible-${e.id}`,className:"text-slate-300 font-normal cursor-pointer flex-1",children:[e.name,e.role&&l.jsxs("span",{className:"ml-2 text-xs text-slate-500",children:["(",e.role,")"]})]})]},e.id))]}):l.jsx("p",{className:"text-slate-400 text-sm",children:"Aucun membre d'Ã©quipe disponible"})}),N.visible_by_ids.length>0&&l.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:N.visible_by_ids.map(e=>{const s=_.find(s=>s.id===e);return s?l.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-xs bg-green-500/20 text-green-300 border border-green-500/30",children:[l.jsx(j,{className:"w-3 h-3 mr-1"}),s.name,l.jsx("button",{type:"button",onClick:()=>{k(s=>({...s,visible_by_ids:s.visible_by_ids.filter(s=>s!==e)}))},className:"ml-2 text-green-300 hover:text-green-100",children:"Ã—"})]},e):null})}),l.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"ðŸ”’ SÃ©lectionnez les personnes autorisÃ©es Ã  consulter cette tÃ¢che. Les administrateurs ont toujours accÃ¨s."})]}),l.jsxs("div",{className:"flex gap-4 pt-6",children:[l.jsx(e,{type:"submit",className:"flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700",children:i?"Mettre Ã  jour":"CrÃ©er la tÃ¢che"}),l.jsx(e,{type:"button",variant:"outline",onClick:r,className:"flex-1 border-slate-600 text-slate-300 hover:bg-slate-700",children:"Annuler"})]})]})]})})},G=({fileUrl:s,fileName:t,onClose:i,onDownload:a})=>{const[r,o]=n.useState(null),[c,d]=n.useState(1),[m,p]=n.useState(0),[h,x]=n.useState(1.5),[g,f]=n.useState(!0),[v,j]=n.useState(null),k=n.useRef(null),C=n.useRef(null),E=n.useRef(null);n.useEffect(()=>(s&&(async()=>{try{f(!0),j(null);const e=(await(async()=>window.pdfjsLib?window.pdfjsLib:new Promise((e,s)=>{const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",t.async=!0,t.onload=()=>{window.pdfjsLib?(window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",e(window.pdfjsLib)):s(new Error("PDF.js not loaded"))},t.onerror=()=>s(new Error("Failed to load PDF.js")),document.head.appendChild(t)}))()).getDocument({url:s,withCredentials:!1,disableRange:!0,disableStream:!0}),t=await e.promise;o(t),p(t.numPages),f(!1)}catch(e){j("Impossible de charger le document PDF. Veuillez rÃ©essayer."),f(!1)}})(),()=>{r&&r.destroy()}),[s]),n.useEffect(()=>{let e=!1;return(async()=>{if(r&&k.current&&!e)try{if(E.current){try{await E.current.cancel()}catch(s){}E.current=null}if(e||!k.current)return;const t=await r.getPage(c);if(e||!k.current)return;const i=t.getViewport({scale:h}),a=k.current,n=a.getContext("2d");n.clearRect(0,0,a.width,a.height),a.height=i.height,a.width=i.width;const l={canvasContext:n,viewport:i};if(e)return;E.current=t.render(l),await E.current.promise,e||(E.current=null)}catch(t){if("RenderingCancelledException"===t.name||e)return;e||j("Erreur lors de l'affichage de la page.")}})(),()=>{if(e=!0,E.current){try{E.current.cancel()}catch(s){}E.current=null}}},[r,c,h]);const T=()=>{c>1&&d(c-1)},S=()=>{c<m&&d(c+1)},F=e=>{"Escape"===e.key?i():"ArrowLeft"===e.key?T():"ArrowRight"===e.key&&S()};return n.useEffect(()=>(document.addEventListener("keydown",F),()=>{document.removeEventListener("keydown",F)}),[c,m]),l.jsx("div",{className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4",onClick:i,children:l.jsxs("div",{className:"bg-slate-900 rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[l.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-slate-700",children:[l.jsxs("div",{className:"flex items-center gap-3",children:[l.jsx("h3",{className:"text-lg font-semibold text-white truncate max-w-md",children:t||"Document PDF"}),!g&&!v&&l.jsxs("span",{className:"text-sm text-slate-400",children:["Page ",c," / ",m]})]}),l.jsx("button",{onClick:i,className:"text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-800 rounded-lg",title:"Fermer (Esc)",children:l.jsx(u,{className:"w-5 h-5"})})]}),l.jsxs("div",{className:"flex items-center justify-between p-3 border-b border-slate-700 bg-slate-800/50",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(e,{variant:"outline",size:"sm",onClick:T,disabled:c<=1||g,className:"h-8 w-8 p-0",title:"Page prÃ©cÃ©dente (â†)",children:l.jsx(_,{className:"w-4 h-4"})}),l.jsx(e,{variant:"outline",size:"sm",onClick:S,disabled:c>=m||g,className:"h-8 w-8 p-0",title:"Page suivante (â†’)",children:l.jsx(y,{className:"w-4 h-4"})})]}),l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(e,{variant:"outline",size:"sm",onClick:()=>{x(e=>Math.max(e-.25,.5))},disabled:h<=.5||g,className:"h-8 w-8 p-0",title:"Zoom arriÃ¨re",children:l.jsx(w,{className:"w-4 h-4"})}),l.jsxs("span",{className:"text-sm text-slate-300 min-w-[60px] text-center",children:[Math.round(100*h),"%"]}),l.jsx(e,{variant:"outline",size:"sm",onClick:()=>{x(e=>Math.min(e+.25,3))},disabled:h>=3||g,className:"h-8 w-8 p-0",title:"Zoom avant",children:l.jsx(N,{className:"w-4 h-4"})})]}),a&&l.jsxs(e,{variant:"outline",size:"sm",onClick:a,className:"flex items-center gap-2",title:"TÃ©lÃ©charger le fichier",children:[l.jsx(b,{className:"w-4 h-4"}),l.jsx("span",{className:"hidden sm:inline",children:"TÃ©lÃ©charger"})]})]}),l.jsxs("div",{ref:C,className:"flex-1 overflow-auto bg-slate-800 flex items-start justify-center p-6",children:[g&&l.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400",children:[l.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"}),l.jsx("p",{children:"Chargement du document..."})]}),v&&l.jsx("div",{className:"flex flex-col items-center justify-center h-full text-red-400",children:l.jsxs("div",{className:"bg-red-500/10 border border-red-500/30 rounded-lg p-6 max-w-md",children:[l.jsx("p",{className:"text-center mb-4",children:v}),l.jsx(e,{variant:"outline",onClick:i,className:"w-full",children:"Fermer"})]})}),!g&&!v&&l.jsx("canvas",{ref:k,className:"shadow-2xl border border-slate-700 bg-white"})]}),l.jsx("div",{className:"p-3 border-t border-slate-700 bg-slate-800/50",children:l.jsx("p",{className:"text-xs text-slate-500 text-center",children:"Utilisez les flÃ¨ches â† â†’ pour naviguer â€¢ Esc pour fermer â€¢ Molette pour zoomer"})})]})})};G.propTypes={fileUrl:r.string.isRequired,fileName:r.string,onClose:r.func.isRequired,onDownload:r.func};const B=({currentUser:r})=>{const[o,c]=n.useState([]),[u,x]=n.useState("suivi"),[f,j]=n.useState(null),[_,y]=n.useState(""),[w,N]=n.useState("all"),[V,B]=n.useState("all"),[H,Z]=n.useState([]),[K,Y]=n.useState([]),[J,Q]=n.useState(null),[X,ee]=n.useState(""),[se,te]=n.useState({}),[ie,ae]=n.useState(null),[ne,le]=n.useState({open:!1,title:"",message:"",onConfirm:null}),[re,oe]=n.useState(null),[ce,de]=n.useState(null),[ue,me]=n.useState(null),[pe,he]=n.useState({open:!1,file:null,taskId:null}),xe=r&&("Gerant"===r.function||"Associe Emerite"===r.function)||r.role&&"admin"===r.role.toLowerCase(),ge=(e,s=25)=>{if(!e||e.length<=s)return e;const t=e.lastIndexOf(".");if(-1===t)return e.substring(0,s-3)+"...";const i=e.substring(0,t),a=e.substring(t),n=s-a.length-3;return n<=0?e.substring(0,s-3)+"...":i.substring(0,n)+"..."+a};n.useEffect(()=>{be(),ve(),xe&&je();const e=async e=>{const{taskId:s}=e.detail||{};if(s)try{const e=await a(s);te(t=>({...t,[s]:e}))}catch(t){}};return window.addEventListener("refreshTaskFiles",e),()=>{window.removeEventListener("refreshTaskFiles",e)}},[xe]);const fe=e=>{const s=Array.isArray(e.attachments)?e.attachments:e.attachments&&""!==e.attachments?JSON.parse(e.attachments):[],t=se[e.id]&&se[e.id].length>0;return s.length>0||t},be=async()=>{let e=i.from("tasks").select("id,title,description,priority,status,deadline,assigned_to_id,assigned_to_ids,assigned_to_name,visible_by_ids,case_id,attachments,created_at,updated_at,created_by_id,created_by_name,assigned_at,main_category,seen_at,completion_comment");!xe&&r?.id&&(e=e.or(`assigned_to_id.eq.${r.id},assigned_to_ids.cs.{${r.id}},visible_by_ids.cs.{${r.id}}`));const{data:t,error:a}=await e.order("created_at",{ascending:!1});if(a)s({variant:"destructive",title:"Erreur",description:"Impossible de charger les tÃ¢ches."});else{const e=[...new Set((t||[]).filter(e=>e.case_id).map(e=>e.case_id))];let s={};if(e.length>0){const{data:t}=await i.from("cases").select("id, title").in("id",e);t&&(s=t.reduce((e,s)=>(e[s.id]=s.title,e),{}))}const a=(t||[]).map(e=>({...e,case_title:e.case_id&&s[e.case_id]||null}));c(a);try{const e=t.map(e=>e.id),{data:s}=await i.from("tasks_files").select("*").in("task_id",e).order("created_at",{ascending:!1});if(s&&s.length>0){const e={};s.forEach(s=>{e[s.task_id]||(e[s.task_id]=[]),e[s.task_id].push({...s,source:"tasks_files",is_accessible:!0,valid_url:s.file_url})}),te(s=>({...s,...e}))}}catch(n){}}},ve=async()=>{const{data:e,error:t}=await i.from("profiles").select("id, name, role");if(t)s({variant:"destructive",title:"Erreur",description:"Impossible de charger les collaborateurs."});else{const s=(e||[]).filter(e=>"admin"!==e.role);Z(s)}},je=async()=>{const{data:e,error:t}=await i.from("cases").select("id, title");t?s({variant:"destructive",title:"Erreur",description:"Impossible de charger les dossiers."}):Y(e)},_e=async(e,t)=>{try{const{data:a}=await i.storage.listBuckets(),n=a?.some(e=>"task-scans"===e.name),l=Date.now(),o=`scan_${l}_${e.name.replaceAll(/[^a-zA-Z0-9.-]/g,"_")}`;if(!n){const i={file_url:`pending_scan/${r.id}/${t}/${o}`,file_name:o,file_size:e.size,file_type:e.type,status:"pending_upload"};return s({title:"ðŸ“· Scan enregistrÃ©",description:`"${e.name}" sera uploadÃ© une fois le systÃ¨me configurÃ©. MÃ©tadonnÃ©es sauvegardÃ©es.`}),i}const c=`${r.id}/${t}/${o}`,{error:d}=await i.storage.from("task-scans").upload(c,e,{cacheControl:"3600",upsert:!1});if(d)return s({title:"âš ï¸ Erreur d'upload du scan",description:`Impossible d'uploader le scan "${e.name}": ${d.message}`}),null;const{data:u}=i.storage.from("task-scans").getPublicUrl(c),m=u?.publicUrl||c;return s({title:"âœ… Scan uploadÃ©",description:`"${e.name}" uploadÃ© (table tasks_files non crÃ©Ã©e)`}),{file_url:m,file_name:o}}catch(a){const i=`scan_${Date.now()}_${e.name.replaceAll(/[^a-zA-Z0-9.-]/g,"_")}`,n=`pending_scan/${r.id}/${t||"new"}/${i}`;return s({title:"ðŸ“· Scan en attente",description:`"${e.name}" sera traitÃ© une fois le systÃ¨me de scan disponible.`}),{file_url:n,file_name:i,status:"pending_upload"}}},ye=async()=>!0,we=e=>{const{filesToUpload:s,scannedFiles:t,...i}=e;return""===i.case_id&&(i.case_id=null),{filesToUpload:s||[],scannedFiles:t||[],data:i}},Ne=async(e,s,t=!1)=>{if("completed"===s)Q(e);else{const i={status:s};"seen"!==s&&"in-progress"!==s||(i.seen_at=(new Date).toISOString()),ke(e,i,null,t)}},ke=async(e,t,a=null,n=!1)=>{null!==a&&(t.completion_comment=a);const{data:l,error:r}=await i.from("tasks").update(t).eq("id",e).select("id,title,description,priority,status,deadline,assigned_to_id,assigned_to_ids,assigned_to_name,visible_by_ids,case_id,attachments,created_at,updated_at,created_by_id,created_by_name,assigned_at,main_category,seen_at,completion_comment");if(r)n||s({variant:"destructive",title:"Erreur",description:"Impossible de changer le statut."});else{let t=null;if(l[0].case_id){const{data:e}=await i.from("cases").select("title").eq("id",l[0].case_id).single();t=e?.title||null}const a={...l[0],case_title:t};c(o.map(s=>s.id===e?a:s)),n||s({title:"âœ… Statut mis Ã  jour"})}},Ce=o.filter(e=>{if(!e||!e.title)return!1;const s=e.title.toLowerCase().includes(_.toLowerCase())||e.description?.toLowerCase().includes(_.toLowerCase()),t="all"===w||e.status===w,i="all"===V||e.priority===V;return s&&t&&i}),Ee={all:o.length,pending:o.filter(e=>"pending"===e.status).length,seen:o.filter(e=>"seen"===e.status).length,"in-progress":o.filter(e=>"in-progress"===e.status).length,completed:o.filter(e=>"completed"===e.status).length},Te=e=>{switch(e){case"pending":return"bg-blue-500/20 text-blue-300 border-blue-500/30";case"seen":return"bg-purple-500/20 text-purple-300 border-purple-500/30";case"in-progress":return"bg-yellow-500/20 text-yellow-300 border-yellow-500/30";case"completed":return"bg-green-500/20 text-green-300 border-green-500/30";default:return"bg-gray-500/20 text-gray-300 border-gray-500/30"}},Se=e=>{switch(e){case"pending":return"En attente";case"seen":return"Vue";case"in-progress":return"En cours";case"completed":return"TerminÃ©e";default:return e}};return l.jsxs("div",{className:"space-y-6",children:[l.jsx("div",{className:"flex items-center justify-between",children:l.jsxs("div",{children:[l.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Gestion des TÃ¢ches"}),l.jsx("p",{className:"text-slate-400",children:"Organisez et suivez vos tÃ¢ches juridiques"})]})}),l.jsx("div",{className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-2",children:l.jsxs("div",{className:"flex space-x-2",children:[l.jsxs(e,{variant:"suivi"===u?"default":"ghost",onClick:()=>x("suivi"),className:"flex-1 justify-center gap-2 "+("suivi"===u?"bg-blue-600":""),children:[l.jsx(k,{className:"w-4 h-4"})," Suivi de TÃ¢ches"]}),l.jsxs(e,{variant:"nouvelle"===u?"default":"ghost",onClick:()=>{x("nouvelle"),j(null)},className:"flex-1 justify-center gap-2 "+("nouvelle"===u?"bg-blue-600":""),children:[l.jsx(C,{className:"w-4 h-4"})," ",f?"Modifier la TÃ¢che":"Nouvelle TÃ¢che"]})]})}),"suivi"===u&&l.jsxs(d.div,{initial:{opacity:0},animate:{opacity:1},children:[l.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6",children:[{key:"all",label:"Total",color:"bg-slate-600"},{key:"pending",label:"En Attente",color:"bg-orange-500"},{key:"seen",label:"Vues",color:"bg-purple-500"},{key:"in-progress",label:"En Cours",color:"bg-blue-500"},{key:"completed",label:"TerminÃ©es",color:"bg-green-500"}].map(e=>l.jsx(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-lg p-4",children:l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsxs("div",{children:[l.jsx("p",{className:"text-slate-400 text-sm",children:e.label}),l.jsx("p",{className:"text-2xl font-bold text-white",children:Ee[e.key]})]}),l.jsx("div",{className:`w-3 h-3 ${e.color} rounded-full`})]})},e.key))}),l.jsx("div",{className:"bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-6 mb-6",children:l.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[l.jsx("div",{className:"flex-1",children:l.jsxs("div",{className:"relative",children:[l.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"}),l.jsx("input",{type:"text",placeholder:"Rechercher une tÃ¢che...",value:_,onChange:e=>y(e.target.value),className:"w-full pl-10 pr-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"})]})}),l.jsxs("div",{className:"flex gap-4",children:[l.jsxs("select",{value:w,onChange:e=>N(e.target.value),className:"px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"all",children:"Tous les statuts"}),l.jsx("option",{value:"pending",children:"En attente"}),l.jsx("option",{value:"seen",children:"Vue"}),l.jsx("option",{value:"in-progress",children:"En cours"}),l.jsx("option",{value:"completed",children:"TerminÃ©es"})]}),l.jsxs("select",{value:V,onChange:e=>B(e.target.value),className:"px-4 py-2 bg-slate-700/50 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500",children:[l.jsx("option",{value:"all",children:"Toutes les prioritÃ©s"}),l.jsx("option",{value:"low",children:"Faible"}),l.jsx("option",{value:"medium",children:"Moyenne"}),l.jsx("option",{value:"high",children:"Ã‰levÃ©e"}),l.jsx("option",{value:"urgent",children:"Urgente"})]})]})]})}),l.jsxs("div",{className:"bg-slate-800/50 backdrop-blur-sm rounded-xl border border-slate-700/50 overflow-hidden",children:[l.jsxs("div",{className:"hidden lg:grid lg:grid-cols-12 gap-4 px-6 py-3 bg-slate-900/50 border-b border-slate-700/30",children:[l.jsx("div",{className:"col-span-1 text-xs font-medium text-slate-400"}),l.jsx("div",{className:"col-span-4 text-xs font-medium text-slate-300",children:"TÃ¢che"}),l.jsx("div",{className:"col-span-2 text-xs font-medium text-slate-300",children:"Dossier"}),l.jsx("div",{className:"col-span-2 text-xs font-medium text-slate-300",children:"Ã‰chÃ©ance & AssignÃ©"}),l.jsx("div",{className:"col-span-2 text-xs font-medium text-slate-300",children:"Statut"}),l.jsx("div",{className:"col-span-1 text-xs font-medium text-slate-300 text-right",children:"PrioritÃ©"})]}),Ce.map((n,u)=>{const f=(e=>{switch(e){case"urgent":case"high":return{label:"HAUTE",class:"bg-red-500/20 text-red-300 border-red-500/40"};case"medium":default:return{label:"MOYENNE",class:"bg-yellow-500/20 text-yellow-300 border-yellow-500/40"};case"low":return{label:"FAIBLE",class:"bg-slate-500/20 text-slate-400 border-slate-500/40"}}})(n.priority);return l.jsxs(d.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.03*u},className:"border-b border-slate-700/30 last:border-0 hover:bg-slate-700/30 transition-colors",children:[l.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-4 px-6 py-4 items-center",children:[l.jsx("div",{className:"lg:col-span-1 flex items-center",children:l.jsx("input",{type:"checkbox",checked:"completed"===n.status,onChange:()=>{"completed"===n.status?Ne(n.id,"in-progress",!0):Ne(n.id,"completed",!1)},className:"w-5 h-5 rounded border-slate-600 bg-slate-700/50 text-blue-500 focus:ring-blue-500 focus:ring-2 cursor-pointer"})}),l.jsx("div",{className:"lg:col-span-4",children:l.jsxs("div",{className:"flex items-start gap-2",children:[l.jsx("h4",{className:"text-sm font-semibold text-white line-clamp-2 flex-1 "+("completed"===n.status?"line-through text-slate-500":""),children:n.title}),fe(n)&&l.jsxs("button",{onClick:async()=>{const e=ie===n.id?null:n.id;if(ae(e),e&&!se[n.id]){const e=await(async(e,s=null)=>{try{return await a(e,s)}catch(t){return[]}})(n.id,n.attachments);te(s=>({...s,[n.id]:e}))}},title:`${se[n.id]?.length||0} document(s) joint(s)`,className:"flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors text-xs",children:[l.jsx(g,{className:"w-3 h-3"}),se[n.id]?.length||0]})]})}),l.jsx("div",{className:"lg:col-span-2",children:n.case_title?l.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-300",children:[l.jsx(p,{className:"w-3 h-3 text-slate-400"}),l.jsx("span",{className:"truncate max-w-[200px]",title:n.case_title,children:n.case_title})]}):l.jsx("span",{className:"text-xs text-slate-500",children:"Aucun dossier"})}),l.jsxs("div",{className:"lg:col-span-2 space-y-1",children:[l.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-300",children:[l.jsx(m,{className:"w-3 h-3 text-slate-400"}),l.jsxs("span",{children:["Ã‰chÃ©ance: ",n.deadline?(_=n.deadline,_?new Date(_).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"N/A"):"N/A"]})]}),l.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-300",children:[l.jsx(h,{className:"w-3 h-3 text-slate-400"}),l.jsxs("span",{children:["AssignÃ© Ã : ",n.assigned_to_name||"Non assignÃ©"]})]})]}),l.jsx("div",{className:"lg:col-span-2 flex items-center gap-2",children:l.jsxs("span",{className:`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium border ${Te(n.status)}`,children:["completed"===n.status&&l.jsx(T,{className:"w-3 h-3 mr-1"}),"pending"===n.status&&l.jsx(S,{className:"w-3 h-3 mr-1 text-blue-300"}),"in-progress"===n.status&&l.jsx(F,{className:"w-3 h-3 mr-1 text-yellow-300"}),Se(n.status)]})}),l.jsxs("div",{className:"lg:col-span-1 flex items-center justify-end gap-2",children:[l.jsx("span",{className:`inline-flex items-center px-2 py-1 rounded text-xs font-bold border ${f.class}`,children:f.label}),l.jsxs("div",{className:"flex items-center gap-1",children:[l.jsx(e,{variant:"ghost",size:"sm",onClick:()=>(e=>{j(e),x("nouvelle")})(n),className:"h-7 w-7 p-0 text-slate-400 hover:text-white hover:bg-slate-700/50",title:"Modifier",children:l.jsx(p,{className:"w-4 h-4"})}),xe&&l.jsx(e,{variant:"ghost",size:"sm",onClick:()=>{le({open:!0,title:"Supprimer la tÃ¢che",message:`Voulez-vous vraiment supprimer la tÃ¢che "${n.title}" ?\n\nCette action est irrÃ©versible.`,onConfirm:()=>{(async e=>{const{error:t}=await i.from("tasks").delete().eq("id",e);if(t)s({variant:"destructive",title:"Erreur",description:"Impossible de supprimer la tÃ¢che."});else{c(o.filter(s=>s.id!==e));const t=new CustomEvent("taskDeleted",{detail:{taskId:e}});window.dispatchEvent(t),s({title:"ðŸ—‘ï¸ TÃ¢che supprimÃ©e",description:"La tÃ¢che a Ã©tÃ© supprimÃ©e."})}})(n.id),le(e=>({...e,open:!1}))}})},className:"h-7 w-7 p-0 text-red-400 hover:text-red-300 hover:bg-red-500/20",title:"Supprimer",children:l.jsx(v,{className:"w-4 h-4"})})]})]})]}),ie===n.id&&(fe(n)||se[n.id]&&se[n.id].length>0)&&l.jsxs(d.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 pt-4 border-t border-slate-700/50",children:[l.jsxs("div",{className:"flex items-center justify-between mb-3",children:[l.jsxs("div",{className:"flex items-center gap-2",children:[l.jsx(p,{className:"w-4 h-4 text-blue-400"}),l.jsxs("h5",{className:"text-sm font-semibold text-blue-400",children:["Documents liÃ©s (",se[n.id]?.length||0,")"]})]}),l.jsxs(e,{variant:"ghost",size:"sm",onClick:()=>(e=>{const i=document.createElement("input");i.type="file",i.multiple=!0,i.accept=".pdf,.doc,.docx,.jpg,.jpeg,.png",i.onchange=async i=>{const a=Array.from(i.target.files);if(0!==a.length){me(e);try{const{uploadMultipleTaskFiles:i}=await t(async()=>{const{uploadMultipleTaskFiles:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFiles:e}},__vite__mapDeps([0,1,2,3,4])),n=await i(a,e,r?.id);if(n.success){const t=se[e]||[];te(s=>({...s,[e]:[...n.data,...t]})),ie!==e&&ae(e),s({title:"âœ… Fichiers ajoutÃ©s",description:`${n.data.length} fichier(s) ajoutÃ©s Ã  la tÃ¢che.`})}else n.errors&&n.errors.length>0&&s({title:"âš ï¸ Erreur d'upload",description:n.summary,variant:"destructive"})}catch(n){s({variant:"destructive",title:"âŒ Erreur d'upload",description:`Ã‰chec de l'upload: ${n.message}`})}finally{me(null)}}},i.click()})(n.id),disabled:ue===n.id,className:"h-7 px-3 gap-1.5 text-blue-400 hover:text-blue-300 hover:bg-blue-500/20",title:"Ajouter un document",children:[l.jsx(A,{className:"w-4 h-4"}),l.jsx("span",{className:"text-xs font-medium",children:"Ajouter un fichier"})]})]}),l.jsx("div",{className:"space-y-2",children:(se[n.id]||[]).map(e=>{const a="attachments"===e.source,r="tasks_files"===e.source,o=r?"ðŸ“":a?"ðŸ“Ž":"ðŸ“·",c=e.is_accessible&&(e.valid_url||e.file_url?.startsWith("http"));return l.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-700/30 rounded-lg border border-slate-600/30 hover:border-slate-500/50 transition-colors",children:[l.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[l.jsx(p,{className:"w-4 h-4 flex-shrink-0 "+(r?"text-green-400":a?"text-slate-400":"text-blue-400")}),l.jsxs("div",{className:"flex-1 min-w-0",children:[l.jsxs("span",{className:"text-sm text-slate-200 block",title:e.file_name,children:[o," ",ge(e.file_name)]}),l.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.file_size&&l.jsxs("span",{className:"text-xs text-slate-500",children:[Math.round(e.file_size/1024)," KB"]}),l.jsxs("span",{className:"text-xs flex items-center gap-1 "+(e.document_category?"text-blue-400":"text-slate-500"),children:[l.jsx("span",{className:"inline-block w-1.5 h-1.5 rounded-full "+(e.document_category?"bg-blue-400":"bg-slate-500")}),e.document_category||"Non classÃ©"]})]})]})]}),c||D(e)?l.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[l.jsx("button",{onClick:async()=>{try{const n=(e.file_name||"").trim().replace(/[\)\]\}]+\s*$/g,""),l=n.lastIndexOf(".");let r="";if(l>0){r=n.substring(l+1).replace(/[^a-z0-9]/gi,"").toLowerCase()}const o=["doc","docx"].includes(r);let c=null;if("pdf"===r)c=await(async e=>{try{if(!e||!e.file_url)return null;let s="attachments",t="";if(e.file_url.startsWith("http")){const i=new URL(e.file_url).pathname.split("/"),a=i.indexOf("public");if(!(-1!==a&&i.length>a+1))return null;s=i[a+1],t=i.slice(a+2).join("/")}else{const i=e.file_url.replace(/^public\//,"").split("/");s=i[0]||"attachments",t=i.slice(1).join("/")}if(!t)return null;const{data:a,error:n}=await i.storage.from(s).createSignedUrl(t,3600,{download:!1});if(n||!a?.signedUrl)return null;const l=new URL(a.signedUrl);return l.searchParams.delete("download"),l.toString()}catch(s){return null}})(e);else{if(!o)return void s({variant:"destructive",title:"Format non supportÃ©",description:"Seuls les fichiers PDF et Word (.doc, .docx) peuvent Ãªtre prÃ©visualisÃ©s."});s({title:"Conversion en cours...",description:"Conversion du document Word en PDF pour prÃ©visualisation"});try{const{getConvertedPdfUrl:s}=await t(async()=>{const{getConvertedPdfUrl:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{getConvertedPdfUrl:e}},__vite__mapDeps([0,1,2,3,4]));c=await s(e)}catch(a){return void s({variant:"destructive",title:"Conversion impossible",description:"Le service de conversion Word â†’ PDF n'est pas disponible. Utilisez le bouton TÃ©lÃ©charger."})}}c?(oe(e),de(c)):s({variant:"destructive",title:"Erreur",description:"Impossible de gÃ©nÃ©rer l'URL de prÃ©visualisation"})}catch(n){s({variant:"destructive",title:"Erreur",description:"Impossible d'ouvrir le fichier en prÃ©visualisation"})}},className:"px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors",title:"PrÃ©visualiser le fichier (PDF et Word supportÃ©s)",children:"PrÃ©visualiser"}),l.jsx("button",{onClick:()=>$(e),className:"p-1.5 text-green-400 hover:text-green-300 transition-colors",title:"TÃ©lÃ©charger le fichier",children:l.jsx(b,{className:"w-4 h-4"})}),l.jsx("button",{onClick:()=>{he({open:!0,file:e,taskId:n.id})},className:"p-1.5 text-red-400 hover:text-red-300 hover:bg-red-500/20 rounded transition-colors",title:"Supprimer le fichier",children:l.jsx(v,{className:"w-4 h-4"})})]}):l.jsx("span",{className:"text-red-500 text-xs flex-shrink-0",title:"Fichier non disponible (ni URL ni backup local)",children:"âŒ Indisponible"})]},`file-${e.id}`)})})]})]},n.id);var _}),0===Ce.length&&l.jsxs("div",{className:"text-center py-16",children:[l.jsx(k,{className:"w-16 h-16 text-slate-600 mx-auto mb-4"}),l.jsx("h3",{className:"text-lg font-semibold text-slate-400 mb-2",children:"Aucune tÃ¢che trouvÃ©e"}),l.jsx("p",{className:"text-sm text-slate-500",children:_||"all"!==w||"all"!==V?"Essayez de modifier vos filtres de recherche":'Cliquez sur "Nouvelle TÃ¢che" pour commencer'})]})]})]}),"nouvelle"===u&&l.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},children:l.jsx(W,{task:f,onSubmit:f?async e=>{const{filesToUpload:a,scannedFiles:n,data:l}=we(e),d=H.find(e=>e.id===l.assigned_to_id);a&&a.length>0&&(async()=>{try{let e;if(a.length>0&&a[0]&&"object"==typeof a[0]&&"file"in a[0]&&"category"in a[0]){const{uploadMultipleTaskFilesWithCategory:s}=await t(async()=>{const{uploadMultipleTaskFilesWithCategory:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFilesWithCategory:e}},__vite__mapDeps([0,1,2,3,4])),i=a[0].category,n=a.map(e=>e.file);e=await s(n,f.id,r?.id,i)}else{const{uploadMultipleTaskFiles:s}=await t(async()=>{const{uploadMultipleTaskFiles:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFiles:e}},__vite__mapDeps([0,1,2,3,4]));e=await s(a,f.id,r?.id)}if(e.success){const t=se[f.id]||[];te(s=>({...s,[f.id]:[...e.data,...t]})),s({title:"âœ… Fichiers uploadÃ©s",description:`${e.data.length} fichier(s) ajoutÃ©s.`})}else e.errors&&e.errors.length>0&&(e.errors.forEach(e=>{}),s({title:"âš ï¸ Erreur upload",description:e.summary,variant:"destructive"}))}catch(e){s({title:"âŒ Erreur d'upload",description:`Ã‰chec de l'upload : ${e.message||"Erreur inconnue"}`,variant:"destructive"})}})().catch(e=>{}),n&&n.length>0&&(async()=>{try{if(n.length>0&&n[0].file&&n[0].category){const{uploadMultipleTaskFilesWithCategory:e}=await t(async()=>{const{uploadMultipleTaskFilesWithCategory:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFilesWithCategory:e}},__vite__mapDeps([0,1,2,3,4])),s=n.reduce((e,s)=>(e[s.category]||(e[s.category]=[]),e[s.category].push(s.file),e),{});for(const[t,i]of Object.entries(s)){(await e(i,f.id,r?.id,t)).success}}else{if(!(await ye()))return;for(const e of n){await _e(e,f.id)}}}catch(e){s({title:"âš ï¸ Erreur upload scan",description:`Impossible d'uploader les scans : ${e.message||"Erreur inconnue"}`,variant:"destructive"})}})().catch(e=>{}),f.assigned_to_id!==l.assigned_to_id&&l.assigned_to_id?(l.assigned_at=(new Date).toISOString(),l.seen_at=null):l.assigned_to_id||(l.assigned_at=null);const{associated_tasks:u,attachments:m,...p}=l,h={...p,assigned_to_name:d?d.name:null,assigned_to_ids:l.assigned_to_id?[l.assigned_to_id]:[]};for(const s of Object.keys(h))""!==h[s]&&void 0!==h[s]||(h[s]=null);const{data:g,error:b}=await i.from("tasks").update(h).eq("id",f.id).select("id,title,description,priority,status,deadline,assigned_to_id,assigned_to_ids,assigned_to_name,visible_by_ids,case_id,created_at,updated_at,created_by_id,created_by_name,assigned_at,main_category,seen_at,completion_comment").single();if(b)s({variant:"destructive",title:"Erreur",description:`Impossible de modifier la tÃ¢che: ${b.message}`});else{let e=null;if(g.case_id){const{data:s}=await i.from("cases").select("title").eq("id",g.case_id).single();e=s?.title||null}const t={...g,case_title:e};if(c(o.map(e=>e.id===f.id?t:e)),j(null),x("suivi"),t?.deadline){const e=new CustomEvent("taskUpdated",{detail:{task:t,deadline:t.deadline}});window.dispatchEvent(e)}let l="La tÃ¢che a Ã©tÃ© mise Ã  jour.";n&&n.length>0&&(l+=` ${n.length} scan(s) en cours d'upload.`),a&&a.length>0&&(l+=` ${a.length} fichier(s) en cours d'upload.`),s({title:"âœ… TÃ¢che modifiÃ©e",description:l})}}:async e=>{const{filesToUpload:a,scannedFiles:n,data:l}=we(e),d=H.find(e=>e.id===l.assigned_to_id),u={...l,assigned_to_name:d?d.name:null,assigned_at:l.assigned_to_id?(new Date).toISOString():null,assigned_to_ids:l.assigned_to_id?[l.assigned_to_id]:[],created_by_id:r.id,created_by_name:r.name},{attachments:m,associated_tasks:p,...h}=u;for(const s of Object.keys(h))""!==h[s]&&void 0!==h[s]||(h[s]=null);const{data:g,error:f}=await i.from("tasks").insert([h]).select("id,title,description,priority,status,deadline,assigned_to_id,assigned_to_ids,assigned_to_name,visible_by_ids,case_id,created_at,updated_at,created_by_id,created_by_name,assigned_at,main_category,seen_at,completion_comment").single();if(f)return void s({variant:"destructive",title:"Erreur",description:`Impossible de crÃ©er la tÃ¢che: ${f.message}`});let b=null;if(g.case_id){const{data:e}=await i.from("cases").select("title").eq("id",g.case_id).single();b=e?.title||null}const v={...g,case_title:b};if(a&&a.length>0&&(async()=>{try{let e;if(a.length>0&&a[0]&&"object"==typeof a[0]&&"file"in a[0]&&"category"in a[0]){const{uploadMultipleTaskFilesWithCategory:s}=await t(async()=>{const{uploadMultipleTaskFilesWithCategory:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFilesWithCategory:e}},__vite__mapDeps([0,1,2,3,4])),i=a[0].category,n=a.map(e=>e.file);e=await s(n,g.id,r?.id,i)}else{const{uploadMultipleTaskFiles:s}=await t(async()=>{const{uploadMultipleTaskFiles:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFiles:e}},__vite__mapDeps([0,1,2,3,4]));e=await s(a,g.id,r?.id)}if(e.success)te(s=>({...s,[g.id]:e.data})),e.data&&e.data.length>0&&ae(g.id),s({title:"âœ… Fichiers uploadÃ©s",description:`${e.data.length} fichier(s) ajoutÃ©s Ã  la tÃ¢che.`});else if(e.errors&&e.errors.length>0){e.errors.forEach(e=>{});const t=e.errors.some(e=>e.error?.includes("bucket 'attachments'")||e.error?.includes("non configur"));s(t?{title:"âš ï¸ Stockage non configurÃ©",description:"Le bucket 'attachments' doit Ãªtre crÃ©Ã© dans Supabase.",variant:"destructive"}:{title:"âš ï¸ Erreur upload",description:e.summary}),e.data&&e.data.length>0&&te(s=>({...s,[g.id]:e.data}))}}catch(e){s({title:"âŒ Erreur d'upload",description:`Ã‰chec de l'upload des fichiers : ${e.message||"Erreur inconnue"}`,variant:"destructive"})}})().catch(e=>{s({title:"âŒ Erreur critique",description:"Une erreur inattendue s'est produite lors de l'upload.",variant:"destructive"})}),n&&n.length>0&&(async()=>{try{if(n.length>0&&n[0].file&&n[0].category){const{uploadMultipleTaskFilesWithCategory:e}=await t(async()=>{const{uploadMultipleTaskFilesWithCategory:e}=await import("./index-0LlzAmpO.js").then(e=>e.o);return{uploadMultipleTaskFilesWithCategory:e}},__vite__mapDeps([0,1,2,3,4])),s=n.reduce((e,s)=>(e[s.category]||(e[s.category]=[]),e[s.category].push(s.file),e),{});for(const[t,i]of Object.entries(s)){(await e(i,g.id,r?.id,t)).success}}else{if(!(await ye()))return;for(const e of n){await _e(e,g.id)}}}catch(e){s({title:"âš ï¸ Erreur upload scan",description:`Impossible d'uploader les scans : ${e.message||"Erreur inconnue"}`,variant:"destructive"})}})().catch(e=>{}),c([v,...o]),a&&a.length>0&&ae(v.id),v.deadline){const e=new CustomEvent("taskCreated",{detail:{task:v,deadline:v.deadline}});window.dispatchEvent(e)}x("suivi");const j=a&&a.length>0?`La nouvelle tÃ¢che a Ã©tÃ© ajoutÃ©e. Upload des ${a.length} fichier(s) en cours.`:"La nouvelle tÃ¢che a Ã©tÃ© ajoutÃ©e.";s({title:"âœ… TÃ¢che crÃ©Ã©e",description:j})},onCancel:()=>{x("suivi"),j(null)},teamMembers:H,cases:K,currentUser:r})}),l.jsx(L,{open:null!==J,onOpenChange:()=>Q(null),children:l.jsxs(M,{children:[l.jsxs(I,{children:[l.jsx(z,{children:"Ajouter un commentaire de clÃ´ture"}),l.jsx(P,{children:"La tÃ¢che est terminÃ©e. Veuillez ajouter un commentaire pour rÃ©sumer le travail effectuÃ©."})]}),l.jsx("textarea",{value:X,onChange:e=>ee(e.target.value),placeholder:"Ex: Le rapport a Ã©tÃ© envoyÃ© au client pour validation.",className:"w-full mt-4 px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500",rows:4}),l.jsxs(R,{children:[l.jsx(U,{onClick:()=>ke(J,{status:"completed"},null,!1),children:"Passer"}),l.jsx(O,{onClick:()=>{J&&(ke(J,{status:"completed"},X,!1),Q(null),ee(""))},children:"Enregistrer"})]})]})}),ce&&re&&l.jsx(G,{fileUrl:ce,fileName:re.file_name,onClose:()=>{de(null),oe(null)},onDownload:()=>$(re)}),l.jsx(L,{open:pe.open,onOpenChange:e=>he(s=>({...s,open:e})),children:l.jsxs(M,{children:[l.jsxs(I,{children:[l.jsx(z,{children:"Supprimer le fichier"}),l.jsxs(P,{children:['Voulez-vous vraiment supprimer le fichier "',pe.file?.file_name,'" ?',l.jsx("br",{}),l.jsx("br",{}),"Cette action est irrÃ©versible et le fichier sera supprimÃ© dÃ©finitivement."]})]}),l.jsxs(R,{children:[l.jsx(U,{onClick:()=>he({open:!1,file:null,taskId:null}),children:"Annuler"}),l.jsx(O,{onClick:()=>{pe.file&&pe.taskId&&(async(e,t)=>{try{if("tasks_files"===e.source&&e.id){const{error:t}=await i.from("tasks_files").delete().eq("id",e.id);if(t)return void s({variant:"destructive",title:"Erreur",description:`Impossible de supprimer le fichier: ${t.message}`})}if(e.file_url)try{let s="attachments",t="";if(e.file_url.startsWith("http")){const i=new URL(e.file_url).pathname.split("/"),a=i.indexOf("public");-1!==a&&i.length>a+1&&(s=i[a+1],t=i.slice(a+2).join("/"))}else{const i=e.file_url.replace(/^public\//,"").split("/");s=i[0]||"attachments",t=i.slice(1).join("/")}if(t){const{error:e}=await i.storage.from(s).remove([t])}}catch(a){}te(s=>({...s,[t]:(s[t]||[]).filter(s=>s.id!==e.id)})),s({title:"âœ… Fichier supprimÃ©",description:`"${e.file_name}" a Ã©tÃ© supprimÃ© avec succÃ¨s.`})}catch(n){s({variant:"destructive",title:"âŒ Erreur",description:`Impossible de supprimer le fichier: ${n.message}`})}})(pe.file,pe.taskId),he({open:!1,file:null,taskId:null})},className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})}),l.jsx(q,{open:ne.open,onOpenChange:e=>le(s=>({...s,open:e})),title:ne.title,message:ne.message,onConfirm:ne.onConfirm})]})};B.propTypes={currentUser:r.shape({id:r.string,name:r.string,email:r.string,role:r.string,function:r.string,permissions:r.object})};export{B as default};
