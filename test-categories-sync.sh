#!/bin/bash
# Test rapide : Affichage cat√©gories + Synchronisation

echo "üß™ TEST RAPIDE : CAT√âGORIES & SYNCHRONISATION"
echo "=============================================="
echo ""

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üìã CHECKLIST VISUELLE"
echo "--------------------"
echo ""

echo "1Ô∏è‚É£ Affichage Cat√©gories dans Documents"
echo "   ${YELLOW}Action${NC}: Ouvrir l'onglet Documents"
echo "   ${YELLOW}V√©rifier${NC}: Badge bleu avec cat√©gorie sous chaque nom de fichier"
echo "   ${YELLOW}Exemple${NC}: \"contrat.pdf\""
echo "              \"‚ö´ Pi√®ces\" (en bleu)"
echo ""

echo "2Ô∏è‚É£ Affichage Cat√©gories dans T√¢ches"
echo "   ${YELLOW}Action${NC}: Ouvrir une t√¢che avec fichiers attach√©s"
echo "   ${YELLOW}V√©rifier${NC}: Cat√©gorie affich√©e √† c√¥t√© de la taille"
echo "   ${YELLOW}Exemple${NC}: \"üìÅ document.pdf\""
echo "              \"125 KB  ‚ö´ Courriers\" (en bleu)"
echo ""

echo "3Ô∏è‚É£ Synchronisation Upload T√¢che ‚Üí Documents"
echo "   ${YELLOW}Action${NC}:"
echo "   - Cr√©er un dossier (ex: \"Dossier Test\")"
echo "   - Cr√©er une t√¢che li√©e √† ce dossier"
echo "   - Uploader un fichier dans la t√¢che"
echo "   - Aller dans Documents"
echo "   ${YELLOW}V√©rifier${NC}: Fichier visible dans Documents avec:"
echo "   ‚Ä¢ Le bon nom"
echo "   ‚Ä¢ La cat√©gorie (si d√©finie)"
echo "   ‚Ä¢ Lien vers le dossier"
echo ""

echo "4Ô∏è‚É£ Colonne document_category en Base"
echo "   ${YELLOW}Action${NC}: Ouvrir Supabase Dashboard > SQL Editor"
echo "   ${YELLOW}Requ√™te${NC}:"
echo "   SELECT column_name, data_type, is_nullable"
echo "   FROM information_schema.columns"
echo "   WHERE table_name = 'tasks_files'"
echo "   AND column_name = 'document_category';"
echo ""
echo "   ${YELLOW}R√©sultat attendu${NC}:"
echo "   column_name       | data_type | is_nullable"
echo "   document_category | text      | YES"
echo ""

echo "5Ô∏è‚É£ Index Performance"
echo "   ${YELLOW}Requ√™te${NC}:"
echo "   SELECT indexname FROM pg_indexes"
echo "   WHERE tablename = 'tasks_files'"
echo "   AND indexname = 'idx_tasks_files_document_category';"
echo ""
echo "   ${YELLOW}R√©sultat attendu${NC}:"
echo "   indexname"
echo "   idx_tasks_files_document_category"
echo ""

echo "6Ô∏è‚É£ Trigger Synchronisation avec Cat√©gorie"
echo "   ${YELLOW}Requ√™te${NC}:"
echo "   SELECT trigger_name, event_manipulation"
echo "   FROM information_schema.triggers"
echo "   WHERE trigger_name = 'trigger_sync_task_file_to_case';"
echo ""
echo "   ${YELLOW}R√©sultat attendu${NC}:"
echo "   trigger_name                    | event_manipulation"
echo "   trigger_sync_task_file_to_case | INSERT"
echo ""

echo "‚úÖ TESTS √Ä COCHER"
echo "----------------"
echo "[ ] 1. Badge cat√©gorie visible dans Documents"
echo "[ ] 2. Badge cat√©gorie visible dans fichiers de T√¢ches"
echo "[ ] 3. Cat√©gorie affich√©e en bleu avec point rond"
echo "[ ] 4. Upload t√¢che ‚Üí Document appara√Æt dans Documents"
echo "[ ] 5. Cat√©gorie pr√©serv√©e lors synchronisation"
echo "[ ] 6. Colonne document_category existe en base"
echo "[ ] 7. Index idx_tasks_files_document_category cr√©√©"
echo "[ ] 8. Trigger trigger_sync_task_file_to_case actif"
echo ""

echo "üìä REQU√äTES DE DEBUG"
echo "-------------------"
echo ""

echo "-- Voir tous documents avec cat√©gories"
echo "SELECT"
echo "  file_name,"
echo "  document_category,"
echo "  CASE"
echo "    WHEN task_id IS NOT NULL AND case_id IS NOT NULL THEN 'Task+Case'"
echo "    WHEN task_id IS NOT NULL THEN 'Task'"
echo "    WHEN case_id IS NOT NULL THEN 'Case'"
echo "  END as link_type"
echo "FROM tasks_files"
echo "ORDER BY created_at DESC"
echo "LIMIT 10;"
echo ""

echo "-- Compter documents par cat√©gorie"
echo "SELECT"
echo "  document_category,"
echo "  COUNT(*) as count"
echo "FROM tasks_files"
echo "GROUP BY document_category"
echo "ORDER BY count DESC;"
echo ""

echo "üöÄ EX√âCUTION"
echo "-----------"
echo "1. Assurez-vous que les migrations SQL sont appliqu√©es:"
echo "   - sql/add_document_category_to_tasks_files.sql"
echo "   - sql/sync_documents_tasks_cases.sql"
echo ""
echo "2. Relancez le serveur:"
echo "   npm run dev"
echo ""
echo "3. Testez visuellement les points ci-dessus"
echo ""
echo "4. Validez les requ√™tes SQL dans Supabase Dashboard"
echo ""
